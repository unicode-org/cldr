<!DOCTYPE html>
<html><head><meta charset="utf-8">
<link rel="stylesheet" type="text/css" media="screen" href="../reports-v2.css">
<link rel="stylesheet" type="text/css" media="screen" href="tr35.css">
<title>Unicode Locale Data Markup Language (LDML) Part 9: Message Format</title></head><body>






































































































































































































































































































































































































































































































































































































































































































<script src="./js/anchor.min.js"></script><div class="header"><table class="header" cellpadding="0" cellspacing="0" width="100%">
    <tbody>
        <tr>
            <td class="icon"><a href="https://www.unicode.org/"><img style="vertical-align:middle;border:0" alt="[Unicode]" src="https://www.unicode.org/webscripts/logo60s2.gif" height="33" width="34"></a>&nbsp;&nbsp;<a class="bar" href="https://www.unicode.org/reports/">Technical Reports</a>
            </td>
        </tr>
        <tr>
            <td class="gray">&nbsp;</td>
        </tr>
    </tbody>
</table></div><div class="body"><h2>Unicode Technical Standard #35</h2><h1>Unicode Locale Data Markup Language (LDML)<br>Part 9: Message Format</h1><table class="simple" width="90%">
<thead>
<tr>
<th>Version</th>
<th>45 (draft)</th>
</tr>
</thead>
<tbody><tr>
<td>Editors</td>
<td>Addison Phillips and <a href="tr35.html#Acknowledgments">other CLDR committee members</a></td>
</tr>
</tbody></table><p>For the full header, summary, and status, see <a href="tr35.html">Part 1: Core</a>.</p><h3><em>Summary</em></h3><p>This specification defines the data model, syntax, processing, and conformance requirements for the next generation of dynamic messages.</p><p>This is a partial document, describing only those parts of the LDML that are relevant for message format. For the other parts of the LDML see the <a href="tr35.html">main LDML document</a> and the links above.</p><h3><em>Status</em></h3><p><em>This is a draft document which may be updated, replaced, or superseded by other documents at any time.
Publication does not imply endorsement by the Unicode Consortium.
This is not a stable document; it is inappropriate to cite this document as other than a work in progress.</em></p><!-- _This document has been reviewed by Unicode members and other interested parties, and has been approved for publication by the Unicode Consortium.
This is a stable document and may be used as reference material or cited as a normative reference by other specifications._ --><blockquote>
<p><em><strong>A Unicode Technical Standard (UTS)</strong> is an independent specification. Conformance to the Unicode Standard does not imply conformance to any UTS.</em></p>
</blockquote><p><em>Please submit corrigenda and other comments with the CLDR bug reporting form [<a href="tr35.html#Bugs">Bugs</a>]. Related information that is useful in understanding this document is found in the <a href="tr35.html#References">References</a>. For the latest version of the Unicode Standard see [<a href="tr35.html#Unicode">Unicode</a>]. For a list of current Unicode Technical Reports see [<a href="tr35.html#Reports">Reports</a>]. For more information about versions of the Unicode Standard, see [<a href="tr35.html#Versions">Versions</a>].</em></p><h2>Parts</h2><p>The LDML specification is divided into the following parts:</p><ul>
<li>Part 1: <a href="tr35.html#Contents">Core</a> (languages, locales, basic structure)</li>
<li>Part 2: <a href="tr35-general.html#Contents">General</a> (display names &amp; transforms, etc.)</li>
<li>Part 3: <a href="tr35-numbers.html#Contents">Numbers</a> (number &amp; currency formatting)</li>
<li>Part 4: <a href="tr35-dates.html#Contents">Dates</a> (date, time, time zone formatting)</li>
<li>Part 5: <a href="tr35-collation.html#Contents">Collation</a> (sorting, searching, grouping)</li>
<li>Part 6: <a href="tr35-info.html#Contents">Supplemental</a> (supplemental data)</li>
<li>Part 7: <a href="tr35-keyboards.html#Contents">Keyboards</a> (keyboard mappings)</li>
<li>Part 8: <a href="tr35-personNames.html#Contents">Person Names</a> (person names)</li>
<li>Part 9: <a href="tr35-messageFormat.html#Contents">MessageFormat</a> (message format)</li>
</ul><h2><a name="Contents">Contents of Part 9, Message Format</a></h2><ul>
<li><a href="#introduction">Introduction</a><ul>
<li><a href="#conformance">Conformance</a></li>
<li><a href="#terminology-and-conventions">Terminology and Conventions</a></li>
<li><a href="#stability-policy">Stability Policy</a></li>
</ul>
</li>
<li><a href="#syntax">Syntax</a><ul>
<li><a href="#design-goals">Design Goals</a></li>
<li><a href="#design-restrictions">Design Restrictions</a></li>
<li><a href="#messages-and-their-syntax">Messages and their Syntax</a><ul>
<li><a href="#well-formed-vs.-valid-messages">Well-formed vs. Valid Messages</a></li>
</ul>
</li>
<li><a href="#the-message">The Message</a><ul>
<li><a href="#declarations">Declarations</a><ul>
<li><a href="#reserved-statements">Reserved Statements</a></li>
</ul>
</li>
<li><a href="#complex-body">Complex Body</a></li>
</ul>
</li>
<li><a href="#pattern">Pattern</a><ul>
<li><a href="#quoted-pattern">Quoted Pattern</a></li>
<li><a href="#text">Text</a></li>
<li><a href="#placeholder">Placeholder</a></li>
</ul>
</li>
<li><a href="#matcher">Matcher</a><ul>
<li><a href="#selector">Selector</a></li>
<li><a href="#variant">Variant</a><ul>
<li><a href="#key">Key</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#expressions">Expressions</a><ul>
<li><a href="#annotation">Annotation</a><ul>
<li><a href="#function">Function</a><ul>
<li><a href="#options">Options</a></li>
</ul>
</li>
<li><a href="#private-use-annotations">Private-Use Annotations</a></li>
<li><a href="#reserved-annotations">Reserved Annotations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#markup">Markup</a></li>
<li><a href="#attributes">Attributes</a></li>
<li><a href="#other-syntax-elements">Other Syntax Elements</a><ul>
<li><a href="#keywords">Keywords</a></li>
<li><a href="#literals">Literals</a></li>
<li><a href="#names-and-identifiers">Names and Identifiers</a></li>
<li><a href="#escape-sequences">Escape Sequences</a></li>
<li><a href="#whitespace">Whitespace</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#complete-abnf">Complete ABNF</a><ul>
<li><a href="#message.abnf"><code>message.abnf</code></a></li>
</ul>
</li>
<li><a href="#errors">Errors</a><ul>
<li><a href="#error-handling">Error Handling</a></li>
<li><a href="#syntax-errors">Syntax Errors</a></li>
<li><a href="#data-model-errors">Data Model Errors</a><ul>
<li><a href="#variant-key-mismatch">Variant Key Mismatch</a></li>
<li><a href="#missing-fallback-variant">Missing Fallback Variant</a></li>
<li><a href="#missing-selector-annotation">Missing Selector Annotation</a></li>
<li><a href="#duplicate-declaration">Duplicate Declaration</a></li>
<li><a href="#duplicate-option-name">Duplicate Option Name</a></li>
</ul>
</li>
<li><a href="#resolution-errors">Resolution Errors</a><ul>
<li><a href="#unresolved-variable">Unresolved Variable</a></li>
<li><a href="#unknown-function">Unknown Function</a></li>
<li><a href="#unsupported-expression">Unsupported Expression</a></li>
<li><a href="#invalid-expression">Invalid Expression</a></li>
<li><a href="#unsupported-statement">Unsupported Statement</a></li>
</ul>
</li>
<li><a href="#selection-errors">Selection Errors</a></li>
<li><a href="#formatting-errors">Formatting Errors</a></li>
</ul>
</li>
<li><a href="#function-registry">Function Registry</a><ul>
<li><a href="#goals">Goals</a></li>
<li><a href="#conformance-and-use">Conformance and Use</a></li>
<li><a href="#registry-data-model">Registry Data Model</a></li>
<li><a href="#example">Example</a></li>
<li><a href="#default-registry">Default Registry</a><ul>
<li><a href="#string-value-selection-and-formatting">String Value Selection and Formatting</a><ul>
<li><a href="#the-string-function">The <code>:string</code> function</a><ul>
<li><a href="#operands">Operands</a></li>
<li><a href="#options">Options</a></li>
<li><a href="#selection">Selection</a></li>
<li><a href="#formatting">Formatting</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#numeric-value-selection-and-formatting">Numeric Value Selection and Formatting</a><ul>
<li><a href="#the-number-function">The <code>:number</code> function</a><ul>
<li><a href="#operands">Operands</a></li>
<li><a href="#options">Options</a></li>
<li><a href="#default-value-of-select-option">Default Value of <code>select</code> Option</a></li>
<li><a href="#percent-style">Percent Style</a></li>
<li><a href="#selection">Selection</a></li>
</ul>
</li>
<li><a href="#the-integer-function">The <code>:integer</code> function</a><ul>
<li><a href="#operands">Operands</a></li>
<li><a href="#options">Options</a></li>
<li><a href="#default-value-of-select-option">Default Value of <code>select</code> Option</a></li>
<li><a href="#percent-style">Percent Style</a></li>
<li><a href="#selection">Selection</a></li>
</ul>
</li>
<li><a href="#number-operands">Number Operands</a></li>
<li><a href="#digit-size-options">Digit Size Options</a></li>
<li><a href="#number-selection">Number Selection</a><ul>
<li><a href="#rule-selection">Rule Selection</a></li>
<li><a href="#determining-exact-literal-match">Determining Exact Literal Match</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#date-and-time-value-formatting">Date and Time Value Formatting</a><ul>
<li><a href="#the-datetime-function">The <code>:datetime</code> function</a><ul>
<li><a href="#operands">Operands</a></li>
<li><a href="#options">Options</a></li>
</ul>
</li>
<li><a href="#the-date-function">The <code>:date</code> function</a><ul>
<li><a href="#operands">Operands</a></li>
<li><a href="#options">Options</a></li>
</ul>
</li>
<li><a href="#the-time-function">The <code>:time</code> function</a><ul>
<li><a href="#operands">Operands</a></li>
<li><a href="#options">Options</a></li>
</ul>
</li>
<li><a href="#date-and-time-operands">Date and Time Operands</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#formatting">Formatting</a><ul>
<li><a href="#formatting-context">Formatting Context</a></li>
<li><a href="#expression-and-markup-resolution">Expression and Markup Resolution</a><ul>
<li><a href="#literal-resolution">Literal Resolution</a></li>
<li><a href="#variable-resolution">Variable Resolution</a></li>
<li><a href="#function-resolution">Function Resolution</a><ul>
<li><a href="#option-resolution">Option Resolution</a></li>
</ul>
</li>
<li><a href="#markup-resolution">Markup Resolution</a></li>
<li><a href="#fallback-resolution">Fallback Resolution</a></li>
</ul>
</li>
<li><a href="#pattern-selection">Pattern Selection</a><ul>
<li><a href="#resolve-selectors">Resolve Selectors</a></li>
<li><a href="#resolve-preferences">Resolve Preferences</a></li>
<li><a href="#filter-variants">Filter Variants</a></li>
<li><a href="#sort-variants">Sort Variants</a></li>
<li><a href="#examples">Examples</a><ul>
<li><a href="#example-1">Example 1</a></li>
<li><a href="#example-2">Example 2</a></li>
<li><a href="#example-3">Example 3</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#formatting">Formatting</a><ul>
<li><a href="#examples">Examples</a></li>
<li><a href="#formatting-fallback-values">Formatting Fallback Values</a></li>
<li><a href="#handling-bidirectional-text">Handling Bidirectional Text</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#interchange-data-model">Interchange Data Model</a><ul>
<li><a href="#messages">Messages</a></li>
<li><a href="#patterns">Patterns</a></li>
<li><a href="#expressions">Expressions</a></li>
<li><a href="#markup">Markup</a></li>
<li><a href="#extensions">Extensions</a></li>
</ul>
</li>
<li><a href="#appendices">Appendices</a><ul>
<li><a href="#security-considerations">Security Considerations</a></li>
<li><a href="#acknowledgements">Acknowledgements</a></li>
</ul>
</li>
</ul><h2>Introduction</h2><p>One of the challenges in adapting software to work for
users with different languages and cultures is the need for <strong><em>dynamic messages</em></strong>.
Whenever a user interface needs to present data as part of a larger string,
that data needs to be formatted (and the message may need to be altered)
to make it culturally accepted and grammatically correct.</p><blockquote>
<p>For example, if your US English (<code>en-US</code>) interface has a message like:</p>
<blockquote>
<p>Your item had 1,023 views on April 3, 2023</p>
</blockquote>
<p>You want the translated message to be appropriately formatted into French:</p>
<blockquote>
<p>Votre article a eu 1 023 vues le 3 avril 2023</p>
</blockquote>
<p>Or Japanese:</p>
<blockquote>
<p>あなたのアイテムは 2023 年 4 月 3 日に 1,023 回閲覧されました。</p>
</blockquote>
</blockquote><p>This specification defines the
data model, syntax, processing, and conformance requirements
for the next generation of <em>dynamic messages</em>.
It is intended for adoption by programming languages and APIs.
This will enable the integration of
existing internationalization APIs (such as the date and number formats shown above),
grammatical matching (such as plurals or genders),
as well as user-defined formats and message selectors.</p><p>The document is the successor to ICU MessageFormat,
henceforth called ICU MessageFormat 1.0.</p><h3>Conformance</h3><p>Everything in this specification is normative except for:
sections marked as non-normative,
all authoring guidelines, diagrams, examples, and notes.</p><p>The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL
NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "NOT RECOMMENDED",
"MAY", and "OPTIONAL" in this document are to be interpreted as
described in BCP 14 [<a href="https://www.rfc-editor.org/rfc/rfc2119">RFC2119</a>]
[<a href="https://www.rfc-editor.org/rfc/rfc8174">RFC8174</a>] when, and only when, they
appear in all capitals, as shown here.</p><h3>Terminology and Conventions</h3><p>A <strong><em>term</em></strong> looks like this when it is defined in this specification.</p><p>A reference to a <em>term</em> looks like this.</p><blockquote>
<p>Examples are non-normative and styled like this.</p>
</blockquote><h3>Stability Policy</h3><div class="markdown-alert markdown-alert-important">
<p class="markdown-alert-title"><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>The provisions of the stability policy are not in effect until
the conclusion of the technical preview and adoption of this specification.</p>
</div><p>Updates to this specification will not change
the syntactical meaning, the runtime output, or other behaviour
of valid messages written for earlier versions of this specification
that only use functions defined in this specification.
Updates to this specification will not remove any syntax provided in this version.
Future versions MAY add additional structure or meaning to existing syntax.</p><p>Updates to this specification will not remove any reserved keywords or sigils.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Future versions may define new keywords.</p>
</div><p>Updates to this specification will not reserve or assign meaning to
any character "sigils" except for those in the <code>reserved</code> production.</p><p>Updates to this specification
will not remove any functions defined in the default registry nor
will they remove any options or option values.
Additional options or option values MAY be defined.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>This does not guarantee that the results of formatting will never change.
Even when the specification doesn't change,
the functions for date formatting, number formatting and so on
will change their results over time.</p>
</div><p>Later specification versions MAY make previously invalid messages valid.</p><p>Updates to this specification will not introduce message syntax that,
when parsed according to earlier versions of this specification,
would produce syntax or data model errors.
Such messages MAY produce errors when formatted
according to an earlier version of this specification.</p><p>From version 2.0, MessageFormat will only reserve, define, or require
function names or function option names
consisting of characters in the ranges a-z, A-Z, and 0-9.
All other names in these categories are reserved for the use of implementations or users.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Users defining custom names SHOULD include at least one character outside these ranges
to ensure that they will be compatible with future versions of this specification.</p>
</div><p>Later versions of this specification will not introduce changes
to the data model that would result in a data model representation
based on this version being invalid.</p><blockquote>
<p>For example, existing interfaces or fields will not be removed.</p>
</blockquote><p>Later versions of this specification MAY introduce changes
to the data model that would result in future data model representations
not being valid for implementations of this version of the data model.</p><blockquote>
<p>For example, a future version could introduce a new keyword,
whose data model representation would be a new interface
that is not recognized by this version's data model.</p>
</blockquote><p>Later specification versions will not introduce syntax that cannot be
represented by this version of the data model.</p><blockquote>
<p>For example, a future version could introduce a new keyword.
The future version's data model would provide an interface for that keyword
while this version of the data model would parse the value into
the interface <code>UnsupportedStatement</code>.
Both data models would be "valid" in their context,
but this version's would be missing any functionality for the new statement type.</p>
</blockquote><h2>Syntax</h2><p>This section defines the formal grammar describing the syntax of a single message.</p><h3>Design Goals</h3><p><em>This section is non-normative.</em></p><p>The design goals of the syntax specification are as follows:</p><ol>
<li><p>The syntax should leverage the familiarity with ICU MessageFormat 1.0
in order to lower the barrier to entry and increase the chance of adoption.
At the same time,
the syntax should fix the <a href="https://github.com/unicode-org/message-format-wg/blob/main/docs/why_mf_next.html">pain points of ICU MessageFormat 1.0</a>.</p>
<ul>
<li><em>Non-Goal</em>: Be backwards-compatible with the ICU MessageFormat 1.0 syntax.</li>
</ul>
</li>
<li><p>The syntax inside translatable content should be easy to understand for humans.
This includes making it clear which parts of the message body <em>are</em> translatable content,
which parts inside it are placeholders for expressions,
as well as making the selection logic predictable and easy to reason about.</p>
<ul>
<li><em>Non-Goal</em>: Make the syntax intuitive enough for non-technical translators to hand-edit.
Instead, we assume that most translators will work with MessageFormat 2
by means of GUI tooling, CAT workbenches etc.</li>
</ul>
</li>
<li><p>The syntax surrounding translatable content should be easy to write and edit
for developers, localization engineers, and easy to parse by machines.</p>
</li>
<li><p>The syntax should make a single message easily embeddable inside many container formats:
<code>.properties</code>, YAML, XML, inlined as string literals in programming languages, etc.
This includes a future <em>MessageResource</em> specification.</p>
<ul>
<li><em>Non-Goal</em>: Support unnecessary escape sequences, which would theirselves require
additional escaping when embedded. Instead, we tolerate direct use of nearly all
characters (including line breaks, control characters, etc.) and rely upon escaping
in those outer formats to aid human comprehension (e.g., depending upon container
format, a U+000A LINE FEED might be represented as <code>\n</code>, <code>\012</code>, <code>\x0A</code>, <code>\u000A</code>,
<code>\U0000000A</code>, <code>&amp;#xA;</code>, <code>&amp;NewLine;</code>, <code>%0A</code>, <code>&lt;LF&gt;</code>, or something else entirely).</li>
</ul>
</li>
</ol><h3>Design Restrictions</h3><p><em>This section is non-normative.</em></p><p>The syntax specification takes into account the following design restrictions:</p><ol>
<li><p>Whitespace outside the translatable content should be insignificant.
It should be possible to define a message entirely on a single line with no ambiguity,
as well as to format it over multiple lines for clarity.</p>
</li>
<li><p>The syntax should define as few special characters and sigils as possible.
Note that this necessitates extra care when presenting messages for human consumption,
because they may contain invisible characters such as U+200B ZERO WIDTH SPACE,
control characters such as U+0000 NULL and U+0009 TAB, permanently reserved noncharacters
(U+FDD0 through U+FDEF and U+<i>n</i>FFFE and U+<i>n</i>FFFF where <i>n</i> is 0x0 through 0x10),
private-use code points (U+E000 through U+F8FF, U+F0000 through U+FFFFD, and
U+100000 through U+10FFFD), unassigned code points, and other potentially confusing content.</p>
</li>
</ol><h3>Messages and their Syntax</h3><p>The purpose of MessageFormat is to allow content to vary at runtime.
This variation might be due to placing a value into the content
or it might be due to selecting a different bit of content based on some data value
or it might be due to a combination of the two.</p><p>MessageFormat calls the template for a given formatting operation a <em>message</em>.</p><p>The values passed in at runtime (which are to be placed into the content or used
to select between different content items) are called <em>external variables</em>.
The author of a <em>message</em> can also assign <em>local variables</em>, including
variables that modify <em>external variables</em>.</p><p>This part of the MessageFormat specification defines the syntax for a <em>message</em>,
along with the concepts and terminology needed when processing a <em>message</em>
during the <a href="#formatting">formatting</a> of a <em>message</em> at runtime.</p><p>The complete formal syntax of a <em>message</em> is described by the <a href="#complete-abnf">ABNF</a>.</p><h4>Well-formed vs. Valid Messages</h4><p>A <em>message</em> is <strong><em><dfn>well-formed</dfn></em></strong> if it satisfies all the rules of the grammar.
Attempting to parse a <em>message</em> that is not <em>well-formed</em> will result in a <em>Syntax Error</em>.</p><p>A <em>message</em> is <strong><em><dfn>valid</dfn></em></strong> if it is <em>well-formed</em> and
<strong>also</strong> meets the additional content restrictions
and semantic requirements about its structure defined below for
<em>declarations</em>, <em>matcher</em> and <em>options</em>.
Attempting to parse a <em>message</em> that is not <em>valid</em> will result in a <em>Data Model Error</em>.</p><h3>The Message</h3><p>A <strong><em><dfn>message</dfn></em></strong> is the complete template for a specific message formatting request.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>This syntax is designed to be embeddable into many different programming languages and formats.
As such, it avoids constructs, such as character escapes, that are specific to any given file
format or processor.
In particular, it avoids using quote characters common to many file formats and formal languages
so that these do not need to be escaped in the body of a <em>message</em>.</p>
</div><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>In general (and except where required by the syntax), whitespace carries no meaning in the structure
of a <em>message</em>. While many of the examples in this spec are written on multiple lines, the formatting
shown is primarily for readability.</p>
<blockquote>
<p><strong>Example</strong> This <em>message</em>:</p>
<pre><code>.local $foo   =   { |horse| }
{{You have a {$foo}!}}
</code></pre>
<p>Can also be written as:</p>
<pre><code>.local $foo={|horse|}{{You have a {$foo}!}}
</code></pre>
<p>An exception to this is: whitespace inside a <em>pattern</em> is <strong>always</strong> significant.</p>
</blockquote>
</div><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The syntax assumes that each <em>message</em> will be displayed with a left-to-right display order
and be processed in the logical character order.
The syntax also permits the use of right-to-left characters in <em>identifiers</em>,
<em>literals</em>, and other values.
This can result in confusion when viewing the <em>message</em>.</p>
<p>Additional restrictions or requirements,
such as permitting the use of certain bidirectional control characters in the syntax,
might be added during the Tech Preview to better manage bidirectional text.
Feedback on the creation and management of <em>messages</em>
containing bidirectional tokens is strongly desired.</p>
</div><p>A <em>message</em> can be a <em>simple message</em> or it can be a <em>complex message</em>.</p><pre><code class="language-abnf">message = simple-message / complex-message
</code></pre><p>A <strong><em><dfn>simple message</dfn></em></strong> contains a single <em>pattern</em>,
with restrictions on its first character.
An empty string is a valid <em>simple message</em>.</p><pre><code class="language-abnf">simple-message = [simple-start pattern]
simple-start   = simple-start-char / text-escape / placeholder
</code></pre><p>A <strong><em><dfn>complex message</dfn></em></strong> is any <em>message</em> that contains <em>declarations</em>,
a <em>matcher</em>, or both.
A <em>complex message</em> always begins with either a keyword that has a <code>.</code> prefix or a <em>quoted pattern</em>
and consists of:</p><ol>
<li>an optional list of <em>declarations</em>, followed by</li>
<li>a <em>complex body</em></li>
</ol><pre><code class="language-abnf">complex-message = *(declaration [s]) complex-body
</code></pre><h4>Declarations</h4><p>A <strong><em><dfn>declaration</dfn></em></strong> binds a <em>variable</em> identifier to a value within the scope of a <em>message</em>.
This <em>variable</em> can then be used in other <em>expressions</em> within the same <em>message</em>.
<em>Declarations</em> are optional: many messages will not contain any <em>declarations</em>.</p><p>An <strong><em><dfn>input-declaration</dfn></em></strong> binds a <em>variable</em> to an external input value.
The <em>variable-expression</em> of an <em>input-declaration</em>
MAY include an <em>annotation</em> that is applied to the external value.</p><p>A <strong><em><dfn>local-declaration</dfn></em></strong> binds a <em>variable</em> to the resolved value of an <em>expression</em>.</p><p>For compatibility with later MessageFormat 2 specification versions,
<em>declarations</em> MAY also include <em>reserved statements</em>.</p><pre><code class="language-abnf">declaration       = input-declaration / local-declaration / reserved-statement
input-declaration = input [s] variable-expression
local-declaration = local s variable [s] "=" [s] expression
</code></pre><p><em>Variables</em>, once declared, MUST NOT be redeclared.
A <em>message</em> that does any of the following is not <em>valid</em> and will produce a
<em>Duplicate Declaration</em> error during processing:</p><ul>
<li>A <em>declaration</em> MUST NOT bind a <em>variable</em>
that appears as a <em>variable</em> anywhere within a previous <em>declaration</em>.</li>
<li>An <em>input-declaration</em> MUST NOT bind a <em>variable</em>
that appears anywhere within the <em>annotation</em> of its <em>variable-expression</em>.</li>
<li>A <em>local-declaration</em> MUST NOT bind a <em>variable</em> that appears in its <em>expression</em>.</li>
</ul><p>A <em>local-declaration</em> MAY overwrite an external input value as long as the
external input value does not appear in a previous <em>declaration</em>.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>These restrictions only apply to <em>declarations</em>.
A <em>placeholder</em> or <em>selector</em> can apply a different annotation to a <em>variable</em>
than one applied to the same <em>variable</em> named in a <em>declaration</em>.
For example, this message is <em>valid</em>:</p>
<pre><code>.input {$var :number maximumFractionDigits=0}
.match {$var :number maximumFractionDigits=2}
0 {{The selector can apply a different annotation to {$var} for the purposes of selection}}
* {{A placeholder in a pattern can apply a different annotation to {$var :number maximumFractionDigits=3}}}
</code></pre>
<p>(See the <a href="#errors">Errors</a> section for examples of invalid messages)</p>
</div><h5>Reserved Statements</h5><p>A <strong><em><dfn>reserved statement</dfn></em></strong> reserves additional <code>.keywords</code>
for use by future versions of this specification.
Any such future keyword must start with <code>.</code>,
followed by two or more lower-case ASCII characters.</p><p>The rest of the statement supports
a similarly wide range of content as <em>reserved annotations</em>,
but it MUST end with one or more <em>expressions</em>.</p><pre><code class="language-abnf">reserved-statement = reserved-keyword [s reserved-body] 1*([s] expression)
reserved-keyword   = "." name
</code></pre><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The <code>reserved-keyword</code> ABNF rule is a simplification,
as it MUST NOT be considered to match any of the existing keywords
<code>.input</code>, <code>.local</code>, or <code>.match</code>.</p>
</div><p>This allows flexibility in future standardization,
as future definitions MAY define additional semantics and constraints
on the contents of these <em>reserved statements</em>.</p><p>Implementations MUST NOT assign meaning or semantics to a <em>reserved statement</em>:
these are reserved for future standardization.
Implementations MUST NOT remove or alter the contents of a <em>reserved statement</em>.</p><h4>Complex Body</h4><p>The <strong><em><dfn>complex body</dfn></em></strong> of a <em>complex message</em> is the part that will be formatted.
The <em>complex body</em> consists of either a <em>quoted pattern</em> or a <em>matcher</em>.</p><pre><code class="language-abnf">complex-body = quoted-pattern / matcher
</code></pre><h3>Pattern</h3><p>A <strong><em><dfn>pattern</dfn></em></strong> contains a sequence of <em>text</em> and <em>placeholders</em> to be formatted as a unit.
Unless there is an error, resolving a <em>message</em> always results in the formatting
of a single <em>pattern</em>.</p><pre><code class="language-abnf">pattern = *(text-char / text-escape / placeholder)
</code></pre><p>A <em>pattern</em> MAY be empty.</p><p>A <em>pattern</em> MAY contain an arbitrary number of <em>placeholders</em> to be evaluated
during the formatting process.</p><h4>Quoted Pattern</h4><p>A <strong><em><dfn>quoted pattern</dfn></em></strong> is a <em>pattern</em> that is "quoted" to prevent
interference with other parts of the <em>message</em>.
A <em>quoted pattern</em> starts with a sequence of two U+007B LEFT CURLY BRACKET <code>{{</code>
and ends with a sequence of two U+007D RIGHT CURLY BRACKET <code>}}</code>.</p><pre><code class="language-abnf">quoted-pattern = "{{" pattern "}}"
</code></pre><p>A <em>quoted pattern</em> MAY be empty.</p><blockquote>
<p>An empty <em>quoted pattern</em>:</p>
<pre><code>{{}}
</code></pre>
</blockquote><h4>Text</h4><p><strong><em><dfn>text</dfn></em></strong> is the translateable content of a <em>pattern</em>.
Any Unicode code point is allowed, except for U+0000 NULL
and the surrogate code points U+D800 through U+DFFF inclusive.
The characters U+005C REVERSE SOLIDUS <code>\</code>,
U+007B LEFT CURLY BRACKET <code>{</code>, and U+007D RIGHT CURLY BRACKET <code>}</code>
MUST be escaped as <code>\\</code>, <code>\{</code>, and <code>\}</code> respectively.</p><p>In the ABNF, <em>text</em> is represented by non-empty sequences of
<code>simple-start-char</code>, <code>text-char</code>, and <code>text-escape</code>.
The first of these is used at the start of a <em>simple message</em>,
and matches <code>text-char</code> except for not allowing U+002E FULL STOP <code>.</code>.
The ABNF uses <code>content-char</code> as a shared base for <em>text</em> and <em>quoted literal</em> characters.</p><p>Whitespace in <em>text</em>, including tabs, spaces, and newlines is significant and MUST
be preserved during formatting.</p><pre><code class="language-abnf">simple-start-char = content-char / s / "@" / "|"
text-char         = content-char / s / "." / "@" / "|"
quoted-char       = content-char / s / "." / "@" / "{" / "}"
reserved-char     = content-char / "."
content-char      = %x01-08        ; omit NULL (%x00), HTAB (%x09) and LF (%x0A)
                  / %x0B-0C        ; omit CR (%x0D)
                  / %x0E-1F        ; omit SP (%x20)
                  / %x21-2D        ; omit . (%x2E)
                  / %x2F-3F        ; omit @ (%x40)
                  / %x41-5B        ; omit \ (%x5C)
                  / %x5D-7A        ; omit { | } (%x7B-7D)
                  / %x7E-2FFF      ; omit IDEOGRAPHIC SPACE (%x3000)
                  / %x3001-D7FF    ; omit surrogates
                  / %xE000-10FFFF
</code></pre><p>When a <em>pattern</em> is quoted by embedding the <em>pattern</em> in curly brackets, the
resulting <em>message</em> can be embedded into
various formats regardless of the container's whitespace trimming rules.
Otherwise, care must be taken to ensure that pattern-significant whitespace is preserved.</p><blockquote>
<p><strong>Example</strong>
In a Java <code>.properties</code> file, the values <code>hello</code> and <code>hello2</code> both contain
an identical <em>message</em> which consists of a single <em>pattern</em>.
This <em>pattern</em> consists of <em>text</em> with exactly three spaces before and after the word "Hello":</p>
<pre><code class="language-properties">hello = {{   Hello   }}
hello2=\   Hello  \
</code></pre>
</blockquote><h4>Placeholder</h4><p>A <strong><em><dfn>placeholder</dfn></em></strong> is an <em>expression</em> or <em>markup</em> that appears inside of a <em>pattern</em>
and which will be replaced during the formatting of a <em>message</em>.</p><pre><code class="language-abnf">placeholder = expression / markup
</code></pre><h3>Matcher</h3><p>A <strong><em><dfn>matcher</dfn></em></strong> is the <em>complex body</em> of a <em>message</em> that allows runtime selection
of the <em>pattern</em> to use for formatting.
This allows the form or content of a <em>message</em> to vary based on values
determined at runtime.</p><p>A <em>matcher</em> consists of the keyword <code>.match</code> followed by at least one <em>selector</em>
and at least one <em>variant</em>.</p><p>When the <em>matcher</em> is processed, the result will be a single <em>pattern</em> that serves
as the template for the formatting process.</p><p>A <em>message</em> can only be considered <em>valid</em> if the following requirements are
satisfied:</p><ul>
<li>The number of <em>keys</em> on each <em>variant</em> MUST be equal to the number of <em>selectors</em>.</li>
<li>At least one <em>variant</em> MUST exist whose <em>keys</em> are all equal to the "catch-all" key <code>*</code>.</li>
<li>Each <em>selector</em> MUST have an <em>annotation</em>,
or contain a <em>variable</em> that directly or indirectly references a <em>declaration</em> with an <em>annotation</em>.</li>
</ul><pre><code class="language-abnf">matcher         = match-statement 1*([s] variant)
match-statement = match 1*([s] selector)
</code></pre><blockquote>
<p>A <em>message</em> with a <em>matcher</em>:</p>
<pre><code>.input {$count :number}
.match {$count}
one {{You have {$count} notification.}}
*   {{You have {$count} notifications.}}
</code></pre>
</blockquote><blockquote>
<p>A <em>message</em> containing a <em>matcher</em> formatted on a single line:</p>
<pre><code>.match {:platform} windows {{Settings}} * {{Preferences}}
</code></pre>
</blockquote><h4>Selector</h4><p>A <strong><em><dfn>selector</dfn></em></strong> is an <em>expression</em> that ranks or excludes the
<em>variants</em> based on the value of the corresponding <em>key</em> in each <em>variant</em>.
The combination of <em>selectors</em> in a <em>matcher</em> thus determines
which <em>pattern</em> will be used during formatting.</p><pre><code class="language-abnf">selector = expression
</code></pre><p>There MUST be at least one <em>selector</em> in a <em>matcher</em>.
There MAY be any number of additional <em>selectors</em>.</p><blockquote>
<p>A <em>message</em> with a single <em>selector</em> that uses a custom <em>function</em>
<code>:hasCase</code> which is a <em>selector</em> that allows the <em>message</em> to choose a <em>pattern</em>
based on grammatical case:</p>
<pre><code>.match {$userName :hasCase}
vocative {{Hello, {$userName :person case=vocative}!}}
accusative {{Please welcome {$userName :person case=accusative}!}}
* {{Hello!}}
</code></pre>
</blockquote><blockquote>
<p>A message with two <em>selectors</em>:</p>
<pre><code>.input {$numLikes :integer}
.input {$numShares :integer}
.match {$numLikes} {$numShares}
0   0   {{Your item has no likes and has not been shared.}}
0   one {{Your item has no likes and has been shared {$numShares} time.}}
0   *   {{Your item has no likes and has been shared {$numShares} times.}}
one 0   {{Your item has {$numLikes} like and has not been shared.}}
one one {{Your item has {$numLikes} like and has been shared {$numShares} time.}}
one *   {{Your item has {$numLikes} like and has been shared {$numShares} times.}}
*   0   {{Your item has {$numLikes} likes and has not been shared.}}
*   one {{Your item has {$numLikes} likes and has been shared {$numShares} time.}}
*   *   {{Your item has {$numLikes} likes and has been shared {$numShares} times.}}
</code></pre>
</blockquote><h4>Variant</h4><p>A <strong><em><dfn>variant</dfn></em></strong> is a <em>quoted pattern</em> associated with a set of <em>keys</em> in a <em>matcher</em>.
Each <em>variant</em> MUST begin with a sequence of <em>keys</em>,
and terminate with a valid <em>quoted pattern</em>.
The number of <em>keys</em> in each <em>variant</em> MUST match the number of <em>selectors</em> in the <em>matcher</em>.</p><p>Each <em>key</em> is separated from each other by whitespace.
Whitespace is permitted but not required between the last <em>key</em> and the <em>quoted pattern</em>.</p><pre><code class="language-abnf">variant = key *(s key) [s] quoted-pattern
key     = literal / "*"
</code></pre><h5>Key</h5><p>A <strong><em><dfn>key</dfn></em></strong> is a value in a <em>variant</em> for use by a <em>selector</em> when ranking
or excluding <em>variants</em> during the <em>matcher</em> process.
A <em>key</em> can be either a <em>literal</em> value or the "catch-all" key <code>*</code>.</p><p>The <strong><em><dfn>catch-all key</dfn></em></strong> is a special key, represented by <code>*</code>,
that matches all values for a given <em>selector</em>.</p><h3>Expressions</h3><p>An <strong><em><dfn>expression</dfn></em></strong> is a part of a <em>message</em> that will be determined
during the <em>message</em>'s formatting.</p><p>An <em>expression</em> MUST begin with U+007B LEFT CURLY BRACKET <code>{</code>
and end with U+007D RIGHT CURLY BRACKET <code>}</code>.
An <em>expression</em> MUST NOT be empty.
An <em>expression</em> cannot contain another <em>expression</em>.
An <em>expression</em> MAY contain one more <em>attributes</em>.</p><p>A <strong><em><dfn>literal-expression</dfn></em></strong> contains a <em>literal</em>,
optionally followed by an <em>annotation</em>.</p><p>A <strong><em><dfn>variable-expression</dfn></em></strong> contains a <em>variable</em>,
optionally followed by an <em>annotation</em>.</p><p>An <strong><em><dfn>annotation-expression</dfn></em></strong> contains an <em>annotation</em> without an <em>operand</em>.</p><pre><code class="language-abnf">expression            = literal-expression
                      / variable-expression
                      / annotation-expression
literal-expression    = "{" [s] literal [s annotation] *(s attribute) [s] "}"
variable-expression   = "{" [s] variable [s annotation] *(s attribute) [s] "}"
annotation-expression = "{" [s] annotation *(s attribute) [s] "}"
</code></pre><p>There are several types of <em>expression</em> that can appear in a <em>message</em>.
All <em>expressions</em> share a common syntax. The types of <em>expression</em> are:</p><ol>
<li>The value of a <em>local-declaration</em></li>
<li>A <em>selector</em></li>
<li>A kind of <em>placeholder</em> in a <em>pattern</em></li>
</ol><p>Additionally, an <em>input-declaration</em> can contain a <em>variable-expression</em>.</p><blockquote>
<p>Examples of different types of <em>expression</em></p>
<p>Declarations:</p>
<pre><code>.input {$x :function option=value}
.local $y = {|This is an expression|}
</code></pre>
<p>Selectors:</p>
<pre><code>.match {$selector :functionRequired}
</code></pre>
<p>Placeholders:</p>
<pre><code>This placeholder contains a literal expression: {|literal|}
This placeholder contains a variable expression: {$variable}
This placeholder references a function on a variable: {$variable :function with=options}
This placeholder contains a function expression with a variable-valued option: {:function option=$variable}
</code></pre>
</blockquote><h4>Annotation</h4><p>An <strong><em><dfn>annotation</dfn></em></strong> is part of an <em>expression</em> containing either
a <em>function</em> together with its associated <em>options</em>, or
a <em>private-use annotation</em> or a <em>reserved annotation</em>.</p><pre><code class="language-abnf">annotation = function
           / private-use-annotation
           / reserved-annotation
</code></pre><p>An <strong><em><dfn>operand</dfn></em></strong> is the <em>literal</em> of a <em>literal-expression</em> or
the <em>variable</em> of a <em>variable-expression</em>.</p><p>An <em>annotation</em> can appear in an <em>expression</em> by itself or following a single <em>operand</em>.
When following an <em>operand</em>, the <em>operand</em> serves as input to the <em>annotation</em>.</p><h5>Function</h5><p>A <strong><em><dfn>function</dfn></em></strong> is named functionality in an <em>annotation</em>.
<em>Functions</em> are used to evaluate, format, select, or otherwise process data
values during formatting.</p><p>Each <em>function</em> is defined by the runtime's <em>function registry</em>.
A <em>function</em>'s entry in the <em>function registry</em> will define
whether the <em>function</em> is a <em>selector</em> or formatter (or both),
whether an <em>operand</em> is required,
what form the values of an <em>operand</em> can take,
what <em>options</em> and <em>option</em> values are valid,
and what outputs might result.
See <a href="#function-registry">function registry</a> for more information.</p><p>A <em>function</em> starts with a prefix sigil <code>:</code> followed by an <em>identifier</em>.
The <em>identifier</em> MAY be followed by one or more <em>options</em>.
<em>Options</em> are not required.</p><pre><code class="language-abnf">function = ":" identifier *(s option)
</code></pre><blockquote>
<p>A <em>message</em> with a <em>function</em> operating on the <em>variable</em> <code>$now</code>:</p>
<pre><code>It is now {$now :datetime}.
</code></pre>
</blockquote><h6>Options</h6><p>An <strong><em><dfn>option</dfn></em></strong> is a key-value pair
containing a named argument that is passed to a <em>function</em>.</p><p>An <em>option</em> has an <em>identifier</em> and a <em>value</em>.
The <em>identifier</em> is separated from the <em>value</em> by an U+003D EQUALS SIGN <code>=</code> along with
optional whitespace.
The value of an <em>option</em> can be either a <em>literal</em> or a <em>variable</em>.</p><p>Multiple <em>options</em> are permitted in an <em>annotation</em>.
<em>Options</em> are separated from the preceding <em>function</em> <em>identifier</em>
and from each other by whitespace.
Each <em>option</em>'s <em>identifier</em> MUST be unique within the <em>annotation</em>:
an <em>annotation</em> with duplicate <em>option</em> <em>identifiers</em> is not valid.</p><p>The order of <em>options</em> is not significant.</p><pre><code class="language-abnf">option = identifier [s] "=" [s] (literal / variable)
</code></pre><blockquote>
<p>Examples of <em>functions</em> with <em>options</em></p>
<p>A <em>message</em> using the <code>:datetime</code> function.
The <em>option</em> <code>weekday</code> has the literal <code>long</code> as its value:</p>
<pre><code>Today is {$date :datetime weekday=long}!
</code></pre>
</blockquote><blockquote>
<p>A <em>message</em> using the <code>:datetime</code> function.
The <em>option</em> <code>weekday</code> has a variable <code>$dateStyle</code> as its value:</p>
<pre><code>Today is {$date :datetime weekday=$dateStyle}!
</code></pre>
</blockquote><h5>Private-Use Annotations</h5><p>A <strong><em><dfn>private-use annotation</dfn></em></strong> is an <em>annotation</em> whose syntax is reserved
for use by a specific implementation or by private agreement between multiple implementations.
Implementations MAY define their own meaning and semantics for <em>private-use annotations</em>.</p><p>A <em>private-use annotation</em> starts with either U+0026 AMPERSAND <code>&amp;</code> or U+005E CIRCUMFLEX ACCENT <code>^</code>.</p><p>Characters, including whitespace, are assigned meaning by the implementation.
The definition of escapes in the <code>reserved-body</code> production, used for the body of
a <em>private-use annotation</em> is an affordance to implementations that
wish to use a syntax exactly like other functions. Specifically:</p><ul>
<li>The characters <code>\</code>, <code>{</code>, and <code>}</code> MUST be escaped as <code>\\</code>, <code>\{</code>, and <code>\}</code> respectively
when they appear in the body of a <em>private-use annotation</em>.</li>
<li>The character <code>|</code> is special: it SHOULD be escaped as <code>\|</code> in a <em>private-use annotation</em>,
but can appear unescaped as long as it is paired with another <code>|</code>.
This is an affordance to allow <em>literals</em> to appear in the private use syntax.</li>
</ul><p>A <em>private-use annotation</em> MAY be empty after its introducing sigil.</p><pre><code class="language-abnf">private-use-annotation = private-start [[s] reserved-body]
private-start          = "^" / "&amp;"
</code></pre><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Users are cautioned that <em>private-use annotations</em> cannot be reliably exchanged
and can result in errors during formatting.
It is generally a better idea to use the function registry
to define additional formatting or annotation options.</p>
</div><blockquote>
<p>Here are some examples of what <em>private-use</em> sequences might look like:</p>
<pre><code>Here's private use with an operand: {$foo &amp;bar}
Here's a placeholder that is entirely private-use: {&amp;anything here}
Here's a private-use function that uses normal function syntax: {$operand ^foo option=|literal|}
The character \| has to be paired or escaped: {&amp;private || |something between| or isolated: \| }
Stop {&amp; "translate 'stop' as a verb" might be a translator instruction or comment }
Protect stuff in {^ph}&lt;a&gt;{^/ph}private use{^ph}&lt;/a&gt;{^/ph}
</code></pre>
</blockquote><h5>Reserved Annotations</h5><p>A <strong><em><dfn>reserved annotation</dfn></em></strong> is an <em>annotation</em> whose syntax is reserved
for future standardization.</p><p>A <em>reserved annotation</em> starts with a reserved character.
The remaining part of a <em>reserved annotation</em>, called a <em>reserved body</em>,
MAY be empty or contain arbitrary text that starts and ends with
a non-whitespace character.</p><p>This allows maximum flexibility in future standardization,
as future definitions MAY define additional semantics and constraints
on the contents of these <em>annotations</em>.</p><p>Implementations MUST NOT assign meaning or semantics to
an <em>annotation</em> starting with <code>reserved-annotation-start</code>:
these are reserved for future standardization.
Whitespace before or after a <em>reserved body</em> is not part of the <em>reserved body</em>.
Implementations MUST NOT remove or alter the contents of a <em>reserved body</em>,
including any interior whitespace,
but MAY remove or alter whitespace before or after the <em>reserved body</em>.</p><p>While a reserved sequence is technically "well-formed",
unrecognized <em>reserved-annotations</em> or <em>private-use-annotations</em> have no meaning.</p><pre><code class="language-abnf">reserved-annotation       = reserved-annotation-start [[s] reserved-body]
reserved-annotation-start = "!" / "%" / "*" / "+" / "&lt;" / "&gt;" / "?" / "~"

reserved-body             = reserved-body-part *([s] reserved-body-part)
reserved-body-part        = reserved-char / reserved-escape / quoted
</code></pre><h3>Markup</h3><p><strong><em><dfn>Markup</dfn></em></strong> <em>placeholders</em> are <em>pattern</em> parts
that can be used to represent non-language parts of a <em>message</em>,
such as inline elements or styling that should apply to a span of parts.</p><p><em>Markup</em> MUST begin with U+007B LEFT CURLY BRACKET <code>{</code>
and end with U+007D RIGHT CURLY BRACKET <code>}</code>.
<em>Markup</em> MAY contain one more <em>attributes</em>.</p><p><em>Markup</em> comes in three forms:</p><p><strong><em><dfn>Markup-open</dfn></em></strong> starts with U+0023 NUMBER SIGN <code>#</code> and
represents an opening element within the <em>message</em>,
such as markup used to start a span.
It MAY include <em>options</em>.</p><p><strong><em><dfn>Markup-standalone</dfn></em></strong> starts with U+0023 NUMBER SIGN <code>#</code>
and has a U+002F SOLIDUS <code>/</code> immediately before its closing <code>}</code>
representing a self-closing or standalone element within the <em>message</em>.
It MAY include <em>options</em>.</p><p><strong><em><dfn>Markup-close</dfn></em></strong> starts with U+002F SOLIDUS <code>/</code> and
is a <em>pattern</em> part ending a span.</p><pre><code class="language-abnf">markup = "{" [s] "#" identifier *(s option) *(s attribute) [s] ["/"] "}"  ; open and standalone
       / "{" [s] "/" identifier *(s option) *(s attribute) [s] "}"  ; close
</code></pre><blockquote>
<p>A <em>message</em> with one <code>button</code> markup span and a standalone <code>img</code> markup element:</p>
<pre><code>{#button}Submit{/button} or {#img alt=|Cancel| /}.
</code></pre>
</blockquote><blockquote>
<p>A <em>message</em> with attributes in the closing tag:</p>
<pre><code>{#ansi attr=|bold,italic|}Bold and italic{/ansi attr=|bold|} italic only {/ansi attr=|italic|} no formatting.}
</code></pre>
</blockquote><p>A <em>markup-open</em> can appear without a corresponding <em>markup-close</em>.
A <em>markup-close</em> can appear without a corresponding <em>markup-open</em>.
<em>Markup</em> <em>placeholders</em> can appear in any order without making the <em>message</em> invalid.
However, specifications or implementations defining <em>markup</em> might impose requirements
on the pairing, ordering, or contents of <em>markup</em> during <em>formatting</em>.</p><h3>Attributes</h3><p><strong><em>Attributes</em> are reserved for standardization by future versions of this specification.</strong>
Examples in this section are meant to be illustrative and
might not match future requirements or usage.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The Tech Preview does not provide a built-in mechanism for overriding
values in the <em>formatting context</em> (most notably the locale)
Nor does it provide a mechanism for identifying specific expressions
such as by assigning a name or id.
The utility of these types of mechanisms has been debated.
There are at least two proposed mechanisms for implementing support for
these.
Specifically, one mechanism would be to reserve specifically-named options,
possibly using a Unicode namespace (i.e. <code>locale=xxx</code> or <code>u:locale=xxx</code>).
Such options would be reserved for use in any and all functions or markup.
The other mechanism would be to use the reserved "expression attribute" syntax
for this purpose (i.e. <code>@locale=xxx</code> or <code>@id=foo</code>)
Neither mechanism was included in this Tech Preview.
Feedback on the preferred mechanism for managing these features
is strongly desired.</p>
<p>In the meantime, function authors and other implementers are cautioned to avoid creating
function-specific or implementation-specific option values for this purpose.
One workaround would be to use the implementation's namespace for these
features to insure later interoperability when such a mechanism is finalized
during the Tech Preview period.
Specifically:</p>
<ul>
<li>Avoid specifying an option for setting the locale of an expression as different from
that of the overall <em>message</em> locale, or use a namespace that later maps to the final
mechanism.</li>
<li>Avoid specifying options for the purpose of linking placeholders
(such as to pair opening markup to closing markup).
If such an option is created, the implementer should use an
implementation-specific namespace.
Users and implementers are cautioned that such options might be
replaced with a standard mechanism in a future version.</li>
<li>Avoid specifying generic options to communicate with translators and
translation tooling (i.e. implementation-specific options that apply to all
functions.
The above are all desirable features.
We welcome contributions to and proposals for such features during the
Technical Preview.</li>
</ul>
</div><p>An <strong><em><dfn>attribute</dfn></em></strong> is an <em>identifier</em> with an optional value
that appears in an <em>expression</em> or in <em>markup</em>.</p><p><em>Attributes</em> are prefixed by a U+0040 COMMERCIAL AT <code>@</code> sign,
followed by an <em>identifier</em>.
An <em>attribute</em> MAY have a <em>value</em> which is separated from the <em>identifier</em>
by an U+003D EQUALS SIGN <code>=</code> along with optional whitespace.
The <em>value</em> of an <em>attribute</em> can be either a <em>literal</em> or a <em>variable</em>.</p><p>Multiple <em>attributes</em> are permitted in an <em>expression</em> or <em>markup</em>.
Each <em>attribute</em> is separated by whitespace.</p><p>The order of <em>attributes</em> is not significant.</p><pre><code class="language-abnf">attribute = "@" identifier [[s] "=" [s] (literal / variable)]
</code></pre><blockquote>
<p>Examples of <em>expressions</em> and <em>markup</em> with <em>attributes</em>:</p>
<p>A <em>message</em> including a <em>literal</em> that should not be translated:</p>
<pre><code>In French, "{|bonjour| @translate=no}" is a greeting
</code></pre>
<p>A <em>message</em> with <em>markup</em> that should not be copied:</p>
<pre><code>Have a {#span @can-copy}great and wonderful{/span @can-copy} birthday!
</code></pre>
</blockquote><h3>Other Syntax Elements</h3><p>This section defines common elements used to construct <em>messages</em>.</p><h4>Keywords</h4><p>A <strong><em><dfn>keyword</dfn></em></strong> is a reserved token that has a unique meaning in the <em>message</em> syntax.</p><p>The following three keywords are defined: <code>.input</code>, <code>.local</code>, and <code>.match</code>.
Keywords are always lowercase and start with U+002E FULL STOP <code>.</code>.</p><pre><code class="language-abnf">input = %s".input"
local = %s".local"
match = %s".match"
</code></pre><h4>Literals</h4><p>A <strong><em><dfn>literal</dfn></em></strong> is a character sequence that appears outside
of <em>text</em> in various parts of a <em>message</em>.
A <em>literal</em> can appear
as a <em>key</em> value,
as the <em>operand</em> of a <em>literal-expression</em>,
or in the value of an <em>option</em>.
A <em>literal</em> MAY include any Unicode code point
except for U+0000 NULL or the surrogate code points U+D800 through U+DFFF.</p><p>All code points are preserved.</p><p>A <strong><em><dfn>quoted</dfn></em></strong> literal begins and ends with U+005E VERTICAL BAR <code>|</code>.
The characters <code>\</code> and <code>|</code> within a <em>quoted</em> literal MUST be
escaped as <code>\\</code> and <code>\|</code>.</p><p>An <strong><em><dfn>unquoted</dfn></em></strong> literal is a <em>literal</em> that does not require the <code>|</code>
quotes around it to be distinct from the rest of the <em>message</em> syntax.
An <em>unquoted</em> MAY be used when the content of the <em>literal</em>
contains no whitespace and otherwise matches the <code>unquoted</code> production.
Any <em>unquoted</em> literal MAY be <em>quoted</em>.
Implementations MUST NOT distinguish between <em>quoted</em> and <em>unquoted</em> literals
that have the same sequence of code points.</p><p><em>Unquoted</em> literals can contain a <em>name</em> or consist of a <em>number-literal</em>.
A <em>number-literal</em> uses the same syntax as JSON and is intended for the encoding
of number values in <em>operands</em> or <em>options</em>, or as <em>keys</em> for <em>variants</em>.</p><pre><code class="language-abnf">literal        = quoted / unquoted
quoted         = "|" *(quoted-char / quoted-escape) "|"
unquoted       = name / number-literal
number-literal = ["-"] (%x30 / (%x31-39 *DIGIT)) ["." 1*DIGIT] [%i"e" ["-" / "+"] 1*DIGIT]
</code></pre><h4>Names and Identifiers</h4><p>An <strong><em><dfn>identifier</dfn></em></strong> is a character sequence that
identifies a <em>function</em>, <em>markup</em>, or <em>option</em>.
Each <em>identifier</em> consists of a <em>name</em> optionally preceeded by
a <em>namespace</em>.
When present, the <em>namespace</em> is separated from the <em>name</em> by a
U+003A COLON <code>:</code>.
Built-in <em>functions</em> and their <em>options</em> do not have a <em>namespace</em> identifier.</p><p>The <em>namespace</em> <code>u</code> (U+0075 LATIN SMALL LETTER U)
is reserved for future standardization.</p><p><em>Function</em> <em>identifiers</em> are prefixed with <code>:</code>.
<em>Markup</em> <em>identifiers</em> are prefixed with <code>#</code> or <code>/</code>.
<em>Option</em> <em>identifiers</em> have no prefix.</p><p>A <strong><em><dfn>name</dfn></em></strong> is a character sequence used in an <em>identifier</em>
or as the name for a <em>variable</em>
or the value of an <em>unquoted</em> <em>literal</em>.</p><p><em>Variable</em> names are prefixed with <code>$</code>.</p><p>Valid content for <em>names</em> is based on <cite>Namespaces in XML 1.0</cite>'s
<a href="https://www.w3.org/TR/xml-names/#NT-NCName">NCName</a>.
This is different from XML's <a href="https://www.w3.org/TR/xml/#NT-Name">Name</a>
in that it MUST NOT contain a U+003A COLON <code>:</code>.
Otherwise, the set of characters allowed in a <em>name</em> is large.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p><em>External variables</em> can be passed in that are not valid <em>names</em>.
Such variables cannot be referenced in a <em>message</em>,
but are not otherwise errors.</p>
</div><p>Examples:</p><blockquote>
<p>A variable:</p>
<pre><code>This has a {$variable}
</code></pre>
<p>A function:</p>
<pre><code>This has a {:function}
</code></pre>
<p>An add-on function from the <code>icu</code> namespace:</p>
<pre><code>This has a {:icu:function}
</code></pre>
<p>An option and an add-on option:</p>
<pre><code>This has {:options option=value icu:option=add_on}
</code></pre>
</blockquote><p>Support for <em>namespaces</em> and their interpretation is implementation-defined
in this release.</p><pre><code class="language-abnf">variable   = "$" name
option     = identifier [s] "=" [s] (literal / variable)

identifier = [namespace ":"] name
namespace  = name
name       = name-start *name-char
name-start = ALPHA / "_"
           / %xC0-D6 / %xD8-F6 / %xF8-2FF
           / %x370-37D / %x37F-1FFF / %x200C-200D
           / %x2070-218F / %x2C00-2FEF / %x3001-D7FF
           / %xF900-FDCF / %xFDF0-FFFC / %x10000-EFFFF
name-char  = name-start / DIGIT / "-" / "."
           / %xB7 / %x300-36F / %x203F-2040
</code></pre><h4>Escape Sequences</h4><p>An <strong><em><dfn>escape sequence</dfn></em></strong> is a two-character sequence starting with
U+005C REVERSE SOLIDUS <code>\</code>.</p><p>An <em>escape sequence</em> allows the appearance of lexically meaningful characters
in the body of <em>text</em>, <em>quoted</em>, or <em>reserved</em> (which includes, in this case,
<em>private-use</em>) sequences respectively:</p><pre><code class="language-abnf">text-escape     = backslash ( backslash / "{" / "}" )
quoted-escape   = backslash ( backslash / "|" )
reserved-escape = backslash ( backslash / "{" / "|" / "}" )
backslash       = %x5C ; U+005C REVERSE SOLIDUS "\"
</code></pre><h4>Whitespace</h4><p><strong><em><dfn>Whitespace</dfn></em></strong> is defined as one or more of
U+0009 CHARACTER TABULATION (tab),
U+000A LINE FEED (new line),
U+000D CARRIAGE RETURN,
U+3000 IDEOGRAPHIC SPACE,
or U+0020 SPACE.</p><p>Inside <em>patterns</em> and <em>quoted literals</em>,
whitespace is part of the content and is recorded and stored verbatim.
Whitespace is not significant outside translatable text, except where required by the syntax.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The character U+3000 IDEOGRAPHIC SPACE is included in whitespace for
compatibility with certain East Asian keyboards and input methods,
in which users might accidentally create these characters in a <em>message</em>.</p>
</div><pre><code class="language-abnf">s = 1*( SP / HTAB / CR / LF / %x3000 )
</code></pre><h2>Complete ABNF</h2><p>The grammar below uses the ABNF notation [<a href="https://www.rfc-editor.org/info/std68">STD68</a>],
including the modifications found in <a href="https://www.rfc-editor.org/rfc/rfc7405">RFC 7405</a>.</p><p>RFC7405 defines a variation of ABNF that is case-sensitive.
Some ABNF tools are only compatible with the specification found in
<a href="https://www.rfc-editor.org/rfc/rfc5234">RFC 5234</a>.
To make <code>message.abnf</code> compatible with that version of ABNF, replace
the rules of the same name with this block:</p><pre><code class="language-abnf">input = %x2E.69.6E.70.75.74  ; ".input"
local = %x2E.6C.6F.63.61.6C  ; ".local"
match = %x2E.6D.61.74.63.68  ; ".match"
</code></pre><h3><code>message.abnf</code></h3><pre><code class="language-abnf">message           = simple-message / complex-message

simple-message    = [simple-start pattern]
simple-start      = simple-start-char / text-escape / placeholder
pattern           = *(text-char / text-escape / placeholder)
placeholder       = expression / markup

complex-message   = *(declaration [s]) complex-body
declaration       = input-declaration / local-declaration / reserved-statement
complex-body      = quoted-pattern / matcher

input-declaration = input [s] variable-expression
local-declaration = local s variable [s] "=" [s] expression

quoted-pattern    = "{{" pattern "}}"

matcher           = match-statement 1*([s] variant)
match-statement   = match 1*([s] selector)
selector          = expression
variant           = key *(s key) [s] quoted-pattern
key               = literal / "*"

; Expressions
expression            = literal-expression
                      / variable-expression
                      / annotation-expression
literal-expression    = "{" [s] literal [s annotation] *(s attribute) [s] "}"
variable-expression   = "{" [s] variable [s annotation] *(s attribute) [s] "}"
annotation-expression = "{" [s] annotation *(s attribute) [s] "}"

annotation            = function
                      / private-use-annotation
                      / reserved-annotation

markup = "{" [s] "#" identifier *(s option) *(s attribute) [s] ["/"] "}"  ; open and standalone
       / "{" [s] "/" identifier *(s option) *(s attribute) [s] "}"  ; close

; Expression and literal parts
function       = ":" identifier *(s option)
option         = identifier [s] "=" [s] (literal / variable)
; Attributes are reserved for future standardization
attribute      = "@" identifier [[s] "=" [s] (literal / variable)]

variable       = "$" name
literal        = quoted / unquoted
quoted         = "|" *(quoted-char / quoted-escape) "|"
unquoted       = name / number-literal
; number-literal matches JSON number (https://www.rfc-editor.org/rfc/rfc8259#section-6)
number-literal = ["-"] (%x30 / (%x31-39 *DIGIT)) ["." 1*DIGIT] [%i"e" ["-" / "+"] 1*DIGIT]

; Keywords; Note that these are case-sensitive
input = %s".input"
local = %s".local"
match = %s".match"

; Reserve additional .keywords for use by future versions of this specification.
reserved-statement = reserved-keyword [s reserved-body] 1*([s] expression)
; Note that the following production is a simplification,
; as this rule MUST NOT be considered to match existing keywords
; (`.input`, `.local`, and `.match`).
reserved-keyword   = "." name

; Reserve additional sigils for use by future versions of this specification.
reserved-annotation       = reserved-annotation-start [[s] reserved-body]
reserved-annotation-start = "!" / "%" / "*" / "+" / "&lt;" / "&gt;" / "?" / "~"

; Reserve sigils for private-use by implementations.
private-use-annotation    = private-start [[s] reserved-body]
private-start             = "^" / "&amp;"
reserved-body             = reserved-body-part *([s] reserved-body-part)
reserved-body-part        = reserved-char / reserved-escape / quoted

; Names and identifiers
; identifier matches https://www.w3.org/TR/REC-xml-names/#NT-QName
; name matches https://www.w3.org/TR/REC-xml-names/#NT-NCName
identifier = [namespace ":"] name
namespace  = name
name       = name-start *name-char
name-start = ALPHA / "_"
           / %xC0-D6 / %xD8-F6 / %xF8-2FF
           / %x370-37D / %x37F-1FFF / %x200C-200D
           / %x2070-218F / %x2C00-2FEF / %x3001-D7FF
           / %xF900-FDCF / %xFDF0-FFFC / %x10000-EFFFF
name-char  = name-start / DIGIT / "-" / "."
           / %xB7 / %x300-36F / %x203F-2040

; Restrictions on characters in various contexts
simple-start-char = content-char / s / "@" / "|"
text-char         = content-char / s / "." / "@" / "|"
quoted-char       = content-char / s / "." / "@" / "{" / "}"
reserved-char     = content-char / "."
content-char      = %x01-08        ; omit NULL (%x00), HTAB (%x09) and LF (%x0A)
                  / %x0B-0C        ; omit CR (%x0D)
                  / %x0E-1F        ; omit SP (%x20)
                  / %x21-2D        ; omit . (%x2E)
                  / %x2F-3F        ; omit @ (%x40)
                  / %x41-5B        ; omit \ (%x5C)
                  / %x5D-7A        ; omit { | } (%x7B-7D)
                  / %x7E-2FFF      ; omit IDEOGRAPHIC SPACE (%x3000)
                  / %x3001-D7FF    ; omit surrogates
                  / %xE000-10FFFF

; Character escapes
text-escape     = backslash ( backslash / "{" / "}" )
quoted-escape   = backslash ( backslash / "|" )
reserved-escape = backslash ( backslash / "{" / "|" / "}" )
backslash       = %x5C ; U+005C REVERSE SOLIDUS "\"

; Whitespace
s = 1*( SP / HTAB / CR / LF / %x3000 )
</code></pre><h2>Errors</h2><p>Errors in messages and their formatting MAY occur and be detected
at different stages of processing.
Where available,
the use of validation tools is recommended,
as early detection of errors makes their correction easier.</p><h3>Error Handling</h3><p><em>Syntax Errors</em> and <em>Data Model Errors</em> apply to all message processors,
and MUST be emitted as soon as possible.
The other error categories are only emitted during formatting,
but it might be possible to detect them with validation tools.</p><p>During selection, an <em>expression</em> handler MUST only emit <em>Resolution Errors</em> and <em>Selection Errors</em>.
During formatting, an <em>expression</em> handler MUST only emit <em>Resolution Errors</em> and <em>Formatting Errors</em>.</p><p><em>Resolution Errors</em> and <em>Formatting Errors</em> in <em>expressions</em> that are not used
in <em>pattern selection</em> or <em>formatting</em> MAY be ignored,
as they do not affect the output of the formatter.</p><p>In all cases, when encountering a runtime error,
a message formatter MUST provide some representation of the message.
An informative error or errors MUST also be separately provided.</p><p>When a message contains more than one error,
or contains some error which leads to further errors,
an implementation which does not emit all of the errors
SHOULD prioritise <em>Syntax Errors</em> and <em>Data Model Errors</em> over others.</p><p>When an error occurs within a <em>selector</em>,
the <em>selector</em> MUST NOT match any <em>variant</em> <em>key</em> other than the catch-all <code>*</code>
and a <em>Resolution Error</em> or a <em>Selection Error</em> MUST be emitted.</p><h3>Syntax Errors</h3><p><strong><em><dfn>Syntax Errors</dfn></em></strong> occur when the syntax representation of a message is not well-formed.</p><blockquote>
<p>Example invalid messages resulting in a <em>Syntax Error</em>:</p>
<pre><code>{{Missing end braces
</code></pre>
<pre><code>{{Missing one end brace}
</code></pre>
<pre><code>Unknown {{expression}}
</code></pre>
<pre><code>.local $var = {|no message body|}
</code></pre>
</blockquote><h3>Data Model Errors</h3><p><strong><em><dfn>Data Model Errors</dfn></em></strong> occur when a message is invalid due to
violating one of the semantic requirements on its structure.</p><h4>Variant Key Mismatch</h4><p>A <strong><em><dfn>Variant Key Mismatch</dfn></em></strong> occurs when the number of keys on a <em>variant</em>
does not equal the number of <em>selectors</em>.</p><blockquote>
<p>Example invalid messages resulting in a <em>Variant Key Mismatch</em> error:</p>
<pre><code>.match {$one :func}
1 2 {{Too many}}
* {{Otherwise}}
</code></pre>
<pre><code>.match {$one :func} {$two :func}
1 2 {{Two keys}}
* {{Missing a key}}
* * {{Otherwise}}
</code></pre>
</blockquote><h4>Missing Fallback Variant</h4><p>A <strong><em><dfn>Missing Fallback Variant</dfn></em></strong> error occurs when the message
does not include a <em>variant</em> with only catch-all keys.</p><blockquote>
<p>Example invalid messages resulting in a <em>Missing Fallback Variant</em> error:</p>
<pre><code>.match {$one :func}
1 {{Value is one}}
2 {{Value is two}}
</code></pre>
<pre><code>.match {$one :func} {$two :func}
1 * {{First is one}}
* 1 {{Second is one}}
</code></pre>
</blockquote><h4>Missing Selector Annotation</h4><p>A <strong><em><dfn>Missing Selector Annotation</dfn></em></strong> error occurs when the <em>message</em>
contains a <em>selector</em> that does not have an <em>annotation</em>,
or contains a <em>variable</em> that does not directly or indirectly reference a <em>declaration</em> with an <em>annotation</em>.</p><blockquote>
<p>Examples of invalid messages resulting in a <em>Missing Selector Annotation</em> error:</p>
<pre><code>.match {$one}
1 {{Value is one}}
* {{Value is not one}}
</code></pre>
<pre><code>.local $one = {|The one|}
.match {$one}
1 {{Value is one}}
* {{Value is not one}}
</code></pre>
<pre><code>.input {$one}
.match {$one}
1 {{Value is one}}
* {{Value is not one}}
</code></pre>
</blockquote><h4>Duplicate Declaration</h4><p>A <strong><em><dfn>Duplicate Declaration</dfn></em></strong> error occurs when a <em>variable</em> is declared more than once.
Note that an input <em>variable</em> is implicitly declared when it is first used,
so explicitly declaring it after such use is also an error.</p><blockquote>
<p>Examples of invalid messages resulting in a <em>Duplicate Declaration</em> error:</p>
<pre><code>.input {$var :number maximumFractionDigits=0}
.input {$var :number minimumFractionDigits=0}
{{Redeclaration of the same variable}}

.local $var = {$ext :number maximumFractionDigits=0}
.input {$var :number minimumFractionDigits=0}
{{Redeclaration of a local variable}}

.input {$var :number minimumFractionDigits=0}
.local $var = {$ext :number maximumFractionDigits=0}
{{Redeclaration of an input variable}}

.input {$var :number minimumFractionDigits=$var2}
.input {$var2 :number}
{{Redeclaration of the implicit input variable $var2}}

.local $var = {$ext :someFunction}
.local $var = {$error}
.local $var2 = {$var2 :error}
{{{$var} cannot be redefined. {$var2} cannot refer to itself}}
</code></pre>
</blockquote><h4>Duplicate Option Name</h4><p>A <strong><em><dfn>Duplicate Option Name</dfn></em></strong> error occurs when the same <em>identifier</em>
appears on the left-hand side of more than one <em>option</em> in the same <em>expression</em>.</p><blockquote>
<p>Examples of invalid messages resulting in a <em>Duplicate Option Name</em> error:</p>
<pre><code>Value is {42 :number style=percent style=decimal}
</code></pre>
<pre><code>.local $foo = {horse :func one=1 two=2 one=1}
{{This is {$foo}}}
</code></pre>
</blockquote><h3>Resolution Errors</h3><p><strong><em><dfn>Resolution Errors</dfn></em></strong> occur when the runtime value of a part of a message
cannot be determined.</p><h4>Unresolved Variable</h4><p>An <strong><em><dfn>Unresolved Variable</dfn></em></strong> error occurs when a variable reference cannot be resolved.</p><blockquote>
<p>For example, attempting to format either of the following messages
would result in an <em>Unresolved Variable</em> error if done within a context that
does not provide for the variable reference <code>$var</code> to be successfully resolved:</p>
<pre><code>The value is {$var}.
</code></pre>
<pre><code>.match {$var :func}
1 {{The value is one.}}
* {{The value is not one.}}
</code></pre>
</blockquote><h4>Unknown Function</h4><p>An <strong><em><dfn>Unknown Function</dfn></em></strong> error occurs when an <em>expression</em> includes
a reference to a function which cannot be resolved.</p><blockquote>
<p>For example, attempting to format either of the following messages
would result in an <em>Unknown Function</em> error if done within a context that
does not provide for the function <code>:func</code> to be successfully resolved:</p>
<pre><code>The value is {horse :func}.
</code></pre>
<pre><code>.match {|horse| :func}
1 {{The value is one.}}
* {{The value is not one.}}
</code></pre>
</blockquote><h4>Unsupported Expression</h4><p>An <strong><em><dfn>Unsupported Expression</dfn></em></strong> error occurs when an expression uses
syntax reserved for future standardization,
or for private implementation use that is not supported by the current implementation.</p><blockquote>
<p>For example, attempting to format this message
would always result in an <em>Unsupported Expression</em> error:</p>
<pre><code>The value is {!horse}.
</code></pre>
<p>Attempting to format this message would result in an <em>Unsupported Expression</em> error
if done within a context that does not support the <code>^</code> private use sigil:</p>
<pre><code>.match {|horse| ^private}
1 {{The value is one.}}
* {{The value is not one.}}
</code></pre>
</blockquote><h4>Invalid Expression</h4><p>An <strong><em><dfn>Invalid Expression</dfn></em></strong> error occurs when a <em>message</em> includes an <em>expression</em>
whose implementation-defined internal requirements produce an error during <em>function resolution</em>
or when a <em>function</em> returns a value (such as <code>null</code>) that the implementation does not support.</p><p>An <strong><em><dfn>Operand Mismatch Error</dfn></em></strong> is an <em>Invalid Expression</em> error that occurs when
an <em>operand</em> provided to a <em>function</em> during <em>function resolution</em> does not match one of the
expected implementation-defined types for that function;
or in which a literal <em>operand</em> value does not have the required format
and thus cannot be processed into one of the expected implementation-defined types
for that specific <em>function</em>.</p><blockquote>
<p>For example, the following <em>message</em> produces an <em>Operand Mismatch Error</em>
(a type of <em>Invalid Expression</em> error)
because the literal <code>|horse|</code> does not match the production <code>number-literal</code>,
which is a requirement of the function <code>:number</code> for its operand:</p>
<pre><code>.local $horse = {horse :number}
{{You have a {$horse}.}}
</code></pre>
<p>The following <em>message</em> might produce an <em>Invalid Expression</em> error if the
the function <code>:function</code> threw an exception or otherwise emitted an error
rather than returning a valid value:</p>
<pre><code>{{This has an invalid expression {$var :function} because it has a bug in it.}}
</code></pre>
</blockquote><h4>Unsupported Statement</h4><p>An <strong><em><dfn>Unsupported Statement</dfn></em></strong> error occurs when a message includes a <em>reserved statement</em>.</p><blockquote>
<p>For example, attempting to format this message
would always result in an <em>Unsupported Statement</em> error:</p>
<pre><code>.some {|horse|}
{{The message body}}
</code></pre>
</blockquote><h3>Selection Errors</h3><p><strong><em><dfn>Selection Errors</dfn></em></strong> occur when message selection fails.</p><blockquote>
<p>For example, attempting to format either of the following messages
might result in a <em>Selection Error</em> if done within a context that
uses a <code>:number</code> selector function which requires its input to be numeric:</p>
<pre><code>.match {|horse| :number}
1 {{The value is one.}}
* {{The value is not one.}}
</code></pre>
<pre><code>.local $sel = {|horse| :number}
.match {$sel}
1 {{The value is one.}}
* {{The value is not one.}}
</code></pre>
</blockquote><h3>Formatting Errors</h3><p><strong><em><dfn>Formatting Errors</dfn></em></strong> occur during the formatting of a resolved value,
for example when encountering a value with an unsupported type
or an internally inconsistent set of options.</p><blockquote>
<p>For example, attempting to format any of the following messages
might result in a <em>Formatting Error</em> if done within a context that</p>
<ol>
<li>provides for the variable reference <code>$user</code> to resolve to
an object <code>{ name: 'Kat', id: 1234 }</code>,</li>
<li>provides for the variable reference <code>$field</code> to resolve to
a string <code>'address'</code>, and</li>
<li>uses a <code>:get</code> formatting function which requires its argument to be an object and
an option <code>field</code> to be provided with a string value,</li>
</ol>
<pre><code>Hello, {horse :get field=name}!
</code></pre>
<pre><code>Hello, {$user :get}!
</code></pre>
<pre><code>.local $id = {$user :get field=id}
{{Hello, {$id :get field=name}!}}
</code></pre>
<pre><code>Your {$field} is {$id :get field=$field}
</code></pre>
</blockquote><h2>Function Registry</h2><p>Implementations and tooling can greatly benefit from a
structured definition of formatting and matching functions available to messages at runtime.
This specification is intended to provide a mechanism for storing such declarations in a portable manner.</p><h3>Goals</h3><p><em>This section is non-normative.</em></p><p>The registry provides a machine-readable description of MessageFormat 2 extensions (custom functions),
in order to support the following goals and use-cases:</p><ul>
<li>Validate semantic properties of messages. For example:<ul>
<li>Type-check values passed into functions.</li>
<li>Validate that matching functions are only called in selectors.</li>
<li>Validate that formatting functions are only called in placeholders.</li>
<li>Verify the exhaustiveness of variant keys given a selector.</li>
</ul>
</li>
<li>Support the localization roundtrip. For example:<ul>
<li>Generate variant keys for a given locale during XLIFF extraction.</li>
</ul>
</li>
<li>Improve the authoring experience. For example:<ul>
<li>Forbid edits to certain function options (e.g. currency options).</li>
<li>Autocomplete function and option names.</li>
<li>Display on-hover tooltips for function signatures with documentation.</li>
<li>Display/edit known message metadata.</li>
<li>Restrict input in GUI by providing a dropdown with all viable option values.</li>
</ul>
</li>
</ul><h3>Conformance and Use</h3><p><em>This section is normative.</em></p><p>To be conformant with MessageFormat 2.0, an implementation MUST implement
the <em>functions</em>, <em>options</em> and <em>option</em> values, <em>operands</em> and outputs
described in the section <a href="#default-registry">Default Registry</a> below.</p><p>Implementations MAY implement additional <em>functions</em> or additional <em>options</em>.
In particular, implementations are encouraged to provide feedback on proposed
<em>options</em> and their values.</p><div class="markdown-alert markdown-alert-important">
<p class="markdown-alert-title"><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>In the Tech Preview, the <a href="#registry-data-model">registry data model</a> should
be regarded as experimental.
Changes to the format are expected during this period.
Feedback on the registry's format and implementation is encouraged!</p>
</div><p>Implementations are not required to provide a machine-readable registry
nor to read or interpret the registry data model in order to be conformant.</p><p>The MessageFormat 2.0 Registry was created to describe
the core set of formatting and selection <em>functions</em>,
including <em>operands</em>, <em>options</em>, and <em>option</em> values.
This is the minimum set of functionality needed for conformance.
By using the same names and values, <em>messages</em> can be used interchangeably
by different implementations,
regardless of programming language or runtime environment.
This ensures that developers do not have to relearn core MessageFormat syntax
and functionality when moving between platforms
and that translators do not need to know about the runtime environment for most
selection or formatting operations.</p><p>The registry provides a machine-readable description of <em>functions</em>
suitable for tools, such as those used in translation automation, so that
variant expansion and information about available <em>options</em> and their effects
are available in the translation ecosystem.
To that end, implementations are strongly encouraged to provide appropriately
tailored versions of the registry for consumption by tools
(even if not included in software distributions)
and to encourage any add-on or plug-in functionality to provide
a registry to support localization tooling.</p><h3>Registry Data Model</h3><p><em>This section is non-normative.</em></p><div class="markdown-alert markdown-alert-important">
<p class="markdown-alert-title"><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>This part of the specification is not part of the Tech Preview.</p>
</div><p>The registry contains descriptions of function signatures.</p><p>The main building block of the registry is the <code>&lt;function&gt;</code> element.
It represents an implementation of a custom function available to translation at runtime.
A function defines a human-readable <code>&lt;description&gt;</code> of its behavior
and one or more machine-readable <em>signatures</em> of how to call it.
Named <code>&lt;validationRule&gt;</code> elements can optionally define regex validation rules for
literals, option values, and variant keys.</p><p>MessageFormat 2 functions can be invoked in two contexts:</p><ul>
<li>inside placeholders, to produce a part of the message's formatted output;
for example, a raw value of <code>|1.5|</code> may be formatted to <code>1,5</code> in a language which uses commas as decimal separators,</li>
<li>inside selectors, to contribute to selecting the appropriate variant among all given variants.</li>
</ul><p>A single <em>function name</em> may be used in both contexts,
regardless of whether it's implemented as one or multiple functions.</p><p>A <em>signature</em> defines one particular set of at most one argument and any number of named options
that can be used together in a single call to the function.
<code>&lt;formatSignature&gt;</code> corresponds to a function call inside a placeholder inside translatable text.
<code>&lt;matchSignature&gt;</code> corresponds to a function call inside a selector.</p><p>A signature may define the positional argument of the function with the <code>&lt;input&gt;</code> element.
If the <code>&lt;input&gt;</code> element is not present, the function is defined as a nullary function.
A signature may also define one or more <code>&lt;option&gt;</code> elements representing <em>named options</em> to the function.
An option can be omitted in a call to the function,
unless the <code>required</code> attribute is present.
They accept either a finite enumeration of values (the <code>values</code> attribute)
or validate their input with a regular expression (the <code>validationRule</code> attribute).
Read-only options (the <code>readonly</code> attribute) can be displayed to translators in CAT tools, but may not be edited.</p><p>As the <code>&lt;input&gt;</code> and <code>&lt;option&gt;</code> rules may be locale-dependent,
each signature can include an <code>&lt;override locales="..."&gt;</code> that extends and overrides
the corresponding input and options rules.
If multiple <code>&lt;override&gt;</code> elements would match the current locale,
only the first one is used.</p><p>Matching-function signatures additionally include one or more <code>&lt;match&gt;</code> elements
to define the keys against which they can match when used as selectors.</p><p>Functions may also include <code>&lt;alias&gt;</code> definitions,
which provide shorthands for commonly used option baskets.
An <em>alias name</em> may be used equivalently to a <em>function name</em> in messages.
Its <code>&lt;setOption&gt;</code> values are always set, and may not be overridden in message annotations.</p><p>If a <code>&lt;function&gt;</code>, <code>&lt;input&gt;</code> or <code>&lt;option&gt;</code> includes multiple <code>&lt;description&gt;</code> elements,
each SHOULD have a different <code>xml:lang</code> attribute value.
This allows for the descriptions of these elements to be themselves localized
according to the preferred locale of the message authors and editors.</p><h3>Example</h3><p>The following <code>registry.xml</code> is an example of a registry file
which may be provided by an implementation to describe its built-in functions.
For the sake of brevity, only <code>locales="en"</code> is considered.</p><pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;!DOCTYPE registry SYSTEM "./registry.dtd"&gt;

&lt;registry xml:lang="en"&gt;
    &lt;function name="platform"&gt;
        &lt;description&gt;Match the current OS.&lt;/description&gt;
        &lt;matchSignature&gt;
            &lt;match values="windows linux macos android ios"/&gt;
        &lt;/matchSignature&gt;
    &lt;/function&gt;

    &lt;validationRule id="anyNumber" regex="-?[0-9]+(\.[0-9]+)"/&gt;
    &lt;validationRule id="positiveInteger" regex="[0-9]+"/&gt;
    &lt;validationRule id="currencyCode" regex="[A-Z]{3}"/&gt;

    &lt;function name="number"&gt;
        &lt;description&gt;
            Format a number.
            Match a **formatted** numerical value against CLDR plural categories or against a number literal.
        &lt;/description&gt;

        &lt;matchSignature&gt;
            &lt;input validationRule="anyNumber"/&gt;
            &lt;option name="type" values="cardinal ordinal"/&gt;
            &lt;option name="minimumIntegerDigits" validationRule="positiveInteger"/&gt;
            &lt;option name="minimumFractionDigits" validationRule="positiveInteger"/&gt;
            &lt;option name="maximumFractionDigits" validationRule="positiveInteger"/&gt;
            &lt;option name="minimumSignificantDigits" validationRule="positiveInteger"/&gt;
            &lt;option name="maximumSignificantDigits" validationRule="positiveInteger"/&gt;
            &lt;!-- Since this applies to both cardinal and ordinal, all plural options are valid. --&gt;
            &lt;match locales="en" values="one two few other" validationRule="anyNumber"/&gt;
            &lt;match values="zero one two few many other" validationRule="anyNumber"/&gt;
        &lt;/matchSignature&gt;

        &lt;formatSignature&gt;
            &lt;input validationRule="anyNumber"/&gt;
            &lt;option name="minimumIntegerDigits" validationRule="positiveInteger"/&gt;
            &lt;option name="minimumFractionDigits" validationRule="positiveInteger"/&gt;
            &lt;option name="maximumFractionDigits" validationRule="positiveInteger"/&gt;
            &lt;option name="minimumSignificantDigits" validationRule="positiveInteger"/&gt;
            &lt;option name="maximumSignificantDigits" validationRule="positiveInteger"/&gt;
            &lt;option name="style" readonly="true" values="decimal currency percent unit" default="decimal"/&gt;
            &lt;option name="currency" readonly="true" validationRule="currencyCode"/&gt;
        &lt;/formatSignature&gt;

        &lt;alias name="integer"&gt;
          &lt;description&gt;Locale-sensitive integral number formatting&lt;/description&gt;
          &lt;setOption name="maximumFractionDigits" value="0" /&gt;
          &lt;setOption name="style" value="decimal" /&gt;
        &lt;/alias&gt;
    &lt;/function&gt;
&lt;/registry&gt;
</code></pre><p>Given the above description, the <code>:number</code> function is defined to work both in a selector and a placeholder:</p><pre><code>.match {$count :number}
1 {{One new message}}
* {{{$count :number} new messages}}
</code></pre><p>Furthermore,
<code>:number</code>'s <code>&lt;matchSignature&gt;</code> contains two <code>&lt;match&gt;</code> elements
which allow the validation of variant keys.
The element whose <code>locales</code> best matches the current locale
using resource item <a href="tr35.html#Lookup">lookup</a> from LDML is used.
An element with no <code>locales</code> attribute is the default
(and is considered equivalent to the <code>root</code> locale).</p><ul>
<li><code>&lt;match locales="en" values="one two few other" .../&gt;</code> can be used in locales like <code>en</code> and <code>en-GB</code>
to validate the <code>when other</code> variant by verifying that the <code>other</code> key is present
in the list of enumarated values: <code>one other</code>.</li>
<li><code>&lt;match ... validationRule="anyNumber"/&gt;</code> can be used to valide the <code>when 1</code> variant
by testing the <code>1</code> key against the <code>anyNumber</code> regular expression defined in the registry file.</li>
</ul><hr><p>A localization engineer can then extend the registry by defining the following <code>customRegistry.xml</code> file.</p><pre><code class="language-xml">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;!DOCTYPE registry SYSTEM "./registry.dtd"&gt;

&lt;registry xml:lang="en"&gt;
    &lt;function name="noun"&gt;
        &lt;description&gt;Handle the grammar of a noun.&lt;/description&gt;
        &lt;formatSignature&gt;
            &lt;override locales="en"&gt;
                &lt;input/&gt;
                &lt;option name="article" values="definite indefinite"/&gt;
                &lt;option name="plural" values="one other"/&gt;
                &lt;option name="case" values="nominative genitive" default="nominative"/&gt;
            &lt;/override&gt;
        &lt;/formatSignature&gt;
    &lt;/function&gt;

    &lt;function name="adjective"&gt;
        &lt;description&gt;Handle the grammar of an adjective.&lt;/description&gt;
        &lt;formatSignature&gt;
            &lt;override locales="en"&gt;
                &lt;input/&gt;
                &lt;option name="article" values="definite indefinite"/&gt;
                &lt;option name="plural" values="one other"/&gt;
                &lt;option name="case" values="nominative genitive" default="nominative"/&gt;
            &lt;/override&gt;
        &lt;/formatSignature&gt;
        &lt;formatSignature&gt;
            &lt;override locales="en"&gt;
                &lt;input/&gt;
                &lt;option name="article" values="definite indefinite"/&gt;
                &lt;option name="accord"/&gt;
            &lt;/override&gt;
        &lt;/formatSignature&gt;
    &lt;/function&gt;
&lt;/registry&gt;
</code></pre><p>Messages can now use the <code>:noun</code> and the <code>:adjective</code> functions.
The following message references the first signature of <code>:adjective</code>,
which expects the <code>plural</code> and <code>case</code> options:</p><blockquote>
<pre><code>You see {$color :adjective article=indefinite plural=one case=nominative} {$object :noun case=nominative}!
</code></pre>
</blockquote><p>The following message references the second signature of <code>:adjective</code>,
which only expects the <code>accord</code> option:</p><blockquote>
<pre><code>.input {$object :noun case=nominative}
{{You see {$color :adjective article=indefinite accord=$object} {$object}!}}
</code></pre>
</blockquote><h3>Default Registry</h3><div class="markdown-alert markdown-alert-important">
<p class="markdown-alert-title"><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>This part of the specification is part of the Tech Preview
and is <strong><em>NORMATIVE</em></strong>.</p>
</div><p>This section describes the functions which each implementation MUST provide
to be conformant with this specification.</p><h4>String Value Selection and Formatting</h4><h5>The <code>:string</code> function</h5><p>The function <code>:string</code> provides string selection and formatting.</p><h6>Operands</h6><p>The <em>operand</em> of <code>:string</code> is either any implementation-defined type
that is a string or for which conversion to a string is supported,
or any <em>literal</em> value.
All other values produce an <em>Invalid Expression</em> error.</p><blockquote>
<p>For example, in Java, implementations of the <code>java.lang.CharSequence</code> interface
(such as <code>java.lang.String</code> or <code>java.lang.StringBuilder</code>),
the type <code>char</code>, or the class <code>java.lang.Character</code> might be considered
as the "implementation-defined types".
Such an implementation might also support other classes via the method <code>toString()</code>.
This might be used to enable selection of a <code>enum</code> value by name, for example.</p>
<p>Other programming languages would define string and character sequence types or
classes according to their local needs, including, where appropriate,
coercion to string.</p>
</blockquote><h6>Options</h6><p>The function <code>:string</code> has no options.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Proposals for string transformation options or implementation
experience with user requirements is desired during the Tech Preview.</p>
</div><h6>Selection</h6><p>When implementing <a href="#resolve-preferences"><code>MatchSelectorKeys(resolvedSelector, keys)</code></a>
where <code>resolvedSelector</code> is the resolved value of a <em>selector</em> <em>expression</em>
and <code>keys</code> is a list of strings,
the <code>:string</code> selector performs as described below.</p><ol>
<li>Let <code>compare</code> be the string value of <code>resolvedSelector</code>.</li>
<li>Let <code>result</code> be a new empty list of strings.</li>
<li>For each string <code>key</code> in <code>keys</code>:<ol>
<li>If <code>key</code> and <code>compare</code> consist of the same sequence of Unicode code points, then<ol>
<li>Append <code>key</code> as the last element of the list <code>result</code>.</li>
</ol>
</li>
</ol>
</li>
<li>Return <code>result</code>.</li>
</ol><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Matching of <code>key</code> and <code>compare</code> values is sensitive to the sequence of code points
in each string.
As a result, variations in how text can be encoded can affect the performance of matching.
The function <code>:string</code> does not perform case folding or Unicode Normalization of string values.
Users SHOULD encode <em>messages</em> and their parts (such as <em>keys</em> and <em>operands</em>),
in Unicode Normalization Form C (NFC) unless there is a very good reason
not to.
See also: <a href="https://www.w3.org/TR/charmod-norm">String Matching</a></p>
</div><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Unquoted string literals in a <em>variant</em> do not include spaces.
If users wish to match strings that include whitespace
(including U+3000 <code>IDEOGRAPHIC SPACE</code>)
to a key, the <code>key</code> needs to be quoted.</p>
<p>For example:</p>
<pre><code>.match {$string :string}
| space key | {{Matches the string " space key "}}
*             {{Matches the string "space key"}}
</code></pre>
</div><h6>Formatting</h6><p>The <code>:string</code> function returns the string value of the resolved value of the <em>operand</em>.</p><h4>Numeric Value Selection and Formatting</h4><h5>The <code>:number</code> function</h5><p>The function <code>:number</code> is a selector and formatter for numeric values.</p><h6>Operands</h6><p>The function <code>:number</code> requires a <a href="#number-operands">Number Operand</a> as its <em>operand</em>.</p><h6>Options</h6><p>Some options do not have default values defined in this specification.
The defaults for these options are implementation-dependent.
In general, the default values for such options depend on the locale,
the value of other options, or both.</p><p>The following options and their values are required to be available on the function <code>:number</code>:</p><ul>
<li><code>select</code><ul>
<li><code>plural</code> (default; see <a href="#default-value-of-select-option">Default Value of <code>select</code> Option</a> below)</li>
<li><code>ordinal</code></li>
<li><code>exact</code></li>
</ul>
</li>
<li><code>compactDisplay</code> (this option only has meaning when combined with the option <code>notation=compact</code>)<ul>
<li><code>short</code> (default)</li>
<li><code>long</code></li>
</ul>
</li>
<li><code>notation</code><ul>
<li><code>standard</code> (default)</li>
<li><code>scientific</code></li>
<li><code>engineering</code></li>
<li><code>compact</code></li>
</ul>
</li>
<li><code>numberingSystem</code><ul>
<li>valid <a href="https://cldr-smoke.unicode.org/spec/main/ldml/tr35.html#UnicodeNumberSystemIdentifier">Unicode Number System Identifier</a>
(default is locale-specific)</li>
</ul>
</li>
<li><code>signDisplay</code><ul>
<li><code>auto</code> (default)</li>
<li><code>always</code></li>
<li><code>exceptZero</code></li>
<li><code>negative</code></li>
<li><code>never</code></li>
</ul>
</li>
<li><code>style</code><ul>
<li><code>decimal</code> (default)</li>
<li><code>percent</code> (see <a href="#percent-style">Percent Style</a> below)</li>
</ul>
</li>
<li><code>useGrouping</code><ul>
<li><code>auto</code> (default)</li>
<li><code>always</code></li>
<li><code>never</code></li>
<li><code>min2</code></li>
</ul>
</li>
<li><code>minimumIntegerDigits</code><ul>
<li>(<a href="#digit-size-options">digit size option</a>, default: <code>1</code>)</li>
</ul>
</li>
<li><code>minimumFractionDigits</code><ul>
<li>(<a href="#digit-size-options">digit size option</a>)</li>
</ul>
</li>
<li><code>maximumFractionDigits</code><ul>
<li>(<a href="#digit-size-options">digit size option</a>)</li>
</ul>
</li>
<li><code>minimumSignificantDigits</code><ul>
<li>(<a href="#digit-size-options">digit size option</a>)</li>
</ul>
</li>
<li><code>maximumSignificantDigits</code><ul>
<li>(<a href="#digit-size-options">digit size option</a>)</li>
</ul>
</li>
</ul><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The following options and option values are being developed during the Technical Preview
period.</p>
</div><p>The following values for the option <code>style</code> are <em>not</em> part of the default registry.
Implementations SHOULD avoid creating options that conflict with these, but
are encouraged to track development of these options during Tech Preview:</p><ul>
<li><code>currency</code></li>
<li><code>unit</code></li>
</ul><p>The following options are <em>not</em> part of the default registry.
Implementations SHOULD avoid creating options that conflict with these, but
are encouraged to track development of these options during Tech Preview:</p><ul>
<li><code>currency</code><ul>
<li>valid <a href="https://cldr-smoke.unicode.org/spec/main/ldml/tr35.html#UnicodeCurrencyIdentifier">Unicode Currency Identifier</a>
(no default)</li>
</ul>
</li>
<li><code>currencyDisplay</code><ul>
<li><code>symbol</code> (default)</li>
<li><code>narrowSymbol</code></li>
<li><code>code</code></li>
<li><code>name</code></li>
</ul>
</li>
<li><code>currencySign</code><ul>
<li><code>accounting</code></li>
<li><code>standard</code> (default)</li>
</ul>
</li>
<li><code>unit</code><ul>
<li>(anything not empty)</li>
</ul>
</li>
<li><code>unitDisplay</code><ul>
<li><code>long</code></li>
<li><code>short</code> (default)</li>
<li><code>narrow</code></li>
</ul>
</li>
</ul><h6>Default Value of <code>select</code> Option</h6><p>The value <code>plural</code> is the default for the option <code>select</code>
because it is the most common use case for numeric selection.
It can be used for exact value matches but also allows for the grammatical needs of
languages using CLDR's plural rules.
This might not be noticeable in the source language (particularly English),
but can cause problems in target locales that the original developer is not considering.</p><blockquote>
<p>For example, a naive developer might use a special message for the value <code>1</code> without
considering a locale's need for a <code>one</code> plural:</p>
<pre><code>.match {$var :number}
1   {{You have one last chance}}
one {{You have {$var} chance remaining}}
*   {{You have {$var} chances remaining}}
</code></pre>
<p>The <code>one</code> variant is needed by languages such as Polish or Russian.
Such locales typically also require other keywords such as <code>two</code>, <code>few</code>, and <code>many</code>.</p>
</blockquote><h6>Percent Style</h6><p>When implementing <code>style=percent</code>, the numeric value of the <em>operand</em>
MUST be multiplied by 100 for the purposes of formatting.</p><blockquote>
<p>For example,</p>
<pre><code>The total was {0.5 :number style=percent}.
</code></pre>
<p>should format in a manner similar to:</p>
<blockquote>
<p>The total was 50%.</p>
</blockquote>
</blockquote><h6>Selection</h6><p>The <em>function</em> <code>:number</code> performs selection as described in <a href="#number-selection">Number Selection</a> below.</p><h5>The <code>:integer</code> function</h5><p>The function <code>:integer</code> is a selector and formatter for matching or formatting numeric
values as integers.</p><h6>Operands</h6><p>The function <code>:integer</code> requires a <a href="#number-operands">Number Operand</a> as its <em>operand</em>.</p><h6>Options</h6><p>Some options do not have default values defined in this specification.
The defaults for these options are implementation-dependent.
In general, the default values for such options depend on the locale,
the value of other options, or both.</p><p>The following options and their values are required in the default registry to be available on the
function <code>:integer</code>:</p><ul>
<li><code>select</code><ul>
<li><code>plural</code> (default)</li>
<li><code>ordinal</code></li>
<li><code>exact</code></li>
</ul>
</li>
<li><code>numberingSystem</code><ul>
<li>valid <a href="https://cldr-smoke.unicode.org/spec/main/ldml/tr35.html#UnicodeNumberSystemIdentifier">Unicode Number System Identifier</a>
(default is locale-specific)</li>
</ul>
</li>
<li><code>signDisplay</code><ul>
<li><code>auto</code> (default)</li>
<li><code>always</code></li>
<li><code>exceptZero</code></li>
<li><code>negative</code></li>
<li><code>never</code></li>
</ul>
</li>
<li><code>style</code><ul>
<li><code>decimal</code> (default)</li>
<li><code>percent</code> (see <a href="#percent-style">Percent Style</a> below)</li>
</ul>
</li>
<li><code>useGrouping</code><ul>
<li><code>auto</code> (default)</li>
<li><code>always</code></li>
<li><code>min2</code></li>
</ul>
</li>
<li><code>minimumIntegerDigits</code><ul>
<li>(<a href="#digit-size-options">digit size option</a>, default: <code>1</code>)</li>
</ul>
</li>
<li><code>maximumSignificantDigits</code><ul>
<li>(<a href="#digit-size-options">digit size option</a>)</li>
</ul>
</li>
</ul><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The following options and option values are being developed during the Technical Preview
period.</p>
</div><p>The following values for the option <code>style</code> are <em>not</em> part of the default registry.
Implementations SHOULD avoid creating options that conflict with these, but
are encouraged to track development of these options during Tech Preview:</p><ul>
<li><code>currency</code></li>
<li><code>unit</code></li>
</ul><p>The following options are <em>not</em> part of the default registry.
Implementations SHOULD avoid creating options that conflict with these, but
are encouraged to track development of these options during Tech Preview:</p><ul>
<li><code>currency</code><ul>
<li>valid <a href="https://cldr-smoke.unicode.org/spec/main/ldml/tr35.html#UnicodeCurrencyIdentifier">Unicode Currency Identifier</a>
(no default)</li>
</ul>
</li>
<li><code>currencyDisplay</code><ul>
<li><code>symbol</code> (default)</li>
<li><code>narrowSymbol</code></li>
<li><code>code</code></li>
<li><code>name</code></li>
</ul>
</li>
<li><code>currencySign</code><ul>
<li><code>accounting</code></li>
<li><code>standard</code> (default)</li>
</ul>
</li>
<li><code>unit</code><ul>
<li>(anything not empty)</li>
</ul>
</li>
<li><code>unitDisplay</code><ul>
<li><code>long</code></li>
<li><code>short</code> (default)</li>
<li><code>narrow</code></li>
</ul>
</li>
</ul><h6>Default Value of <code>select</code> Option</h6><p>The value <code>plural</code> is the default for the option <code>select</code>
because it is the most common use case for numeric selection.
It can be used for exact value matches but also allows for the grammatical needs of
languages using CLDR's plural rules.
This might not be noticeable in the source language (particularly English),
but can cause problems in target locales that the original developer is not considering.</p><blockquote>
<p>For example, a naive developer might use a special message for the value <code>1</code> without
considering a locale's need for a <code>one</code> plural:</p>
<pre><code>.match {$var :integer}
1   {{You have one last chance}}
one {{You have {$var} chance remaining}}
*   {{You have {$var} chances remaining}}
</code></pre>
<p>The <code>one</code> variant is needed by languages such as Polish or Russian.
Such locales typically also require other keywords such as <code>two</code>, <code>few</code>, and <code>many</code>.</p>
</blockquote><h6>Percent Style</h6><p>When implementing <code>style=percent</code>, the numeric value of the <em>operand</em>
MUST be multiplied by 100 for the purposes of formatting.</p><blockquote>
<p>For example,</p>
<pre><code>The total was {0.5 :number style=percent}.
</code></pre>
<p>should format in a manner similar to:</p>
<blockquote>
<p>The total was 50%.</p>
</blockquote>
</blockquote><h6>Selection</h6><p>The <em>function</em> <code>:integer</code> performs selection as described in <a href="#number-selection">Number Selection</a> below.</p><h5>Number Operands</h5><p>The <em>operand</em> of a number function is either an implementation-defined type or
a literal whose contents match the <code>number-literal</code> production in the <a href="#complete-abnf">ABNF</a>.
All other values produce an <em>Invalid Expression</em> error.</p><blockquote>
<p>For example, in Java, any subclass of <code>java.lang.Number</code> plus the primitive
types (<code>byte</code>, <code>short</code>, <code>int</code>, <code>long</code>, <code>float</code>, <code>double</code>, etc.)
might be considered as the "implementation-defined numeric types".
Implementations in other programming languages would define different types
or classes according to their local needs.</p>
</blockquote><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>String values passed as variables in the <em>formatting context</em>'s
<em>input mapping</em> can be formatted as numeric values as long as their
contents match the <code>number-literal</code> production in the <a href="#complete-abnf">ABNF</a>.</p>
<p>For example, if the value of the variable <code>num</code> were the string
<code>-1234.567</code>, it would behave identically to the local
variable in this example:</p>
<pre><code>.local $example = {|-1234.567| :number}
{{{$num :number} == {$example}}}
</code></pre>
</div><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Implementations are encouraged to provide support for compound types or data structures
that provide additional semantic meaning to the formatting of number-like values.
For example, in ICU4J, the type <code>com.ibm.icu.util.Measure</code> can be used to communicate
a value that includes a unit
or the type <code>com.ibm.icu.util.CurrencyAmount</code> can be used to set the currency and related
options (such as the number of fraction digits).</p>
</div><h5>Digit Size Options</h5><p>Some <em>options</em> of number <em>functions</em> are defined to take a "digit size option".
Implementations of number <em>functions</em> use these <em>options</em> to control aspects of numeric display
such as the number of fraction, integer, or significant digits.</p><p>A "digit size option" is an <em>option</em> value that the <em>function</em> interprets
as a small integer value greater than or equal to zero.
Implementations MAY define an upper limit on the resolved value
of a digit size option option consistent with that implementation's practical limits.</p><p>In most cases, the value of a digit size option will be a string that
encodes the value as a decimal integer.
Implementations MAY also accept implementation-defined types as the value.
When provided as a string, the representation of a digit size option matches the following ABNF:</p><blockquote>
<pre><code class="language-abnf">digit-size-option = "0" / (("1"-"9") [DIGIT])
</code></pre>
</blockquote><h5>Number Selection</h5><p>Number selection has three modes:</p><ul>
<li><code>exact</code> selection matches the operand to explicit numeric keys exactly</li>
<li><code>plural</code> selection matches the operand to explicit numeric keys exactly
or to plural rule categories if there is no explicit match</li>
<li><code>ordinal</code> selection matches the operand to explicit numeric keys exactly
or to ordinal rule categories if there is no explicit match</li>
</ul><p>When implementing <a href="#resolve-preferences"><code>MatchSelectorKeys(resolvedSelector, keys)</code></a>
where <code>resolvedSelector</code> is the resolved value of a <em>selector</em> <em>expression</em>
and <code>keys</code> is a list of strings,
numeric selectors perform as described below.</p><ol>
<li>Let <code>exact</code> be the JSON string representation of the numeric value of <code>resolvedSelector</code>.
(See <a href="#determining-exact-literal-match">Determining Exact Literal Match</a> for details)</li>
<li>Let <code>keyword</code> be a string which is the result of <a href="#rule-selection">rule selection</a> on <code>resolvedSelector</code>.</li>
<li>Let <code>resultExact</code> be a new empty list of strings.</li>
<li>Let <code>resultKeyword</code> be a new empty list of strings.</li>
<li>For each string <code>key</code> in <code>keys</code>:<ol>
<li>If the value of <code>key</code> matches the production <code>number-literal</code>, then<ol>
<li>If <code>key</code> and <code>exact</code> consist of the same sequence of Unicode code points, then<ol>
<li>Append <code>key</code> as the last element of the list <code>resultExact</code>.</li>
</ol>
</li>
</ol>
</li>
<li>Else if <code>key</code> is one of the keywords <code>zero</code>, <code>one</code>, <code>two</code>, <code>few</code>, <code>many</code>, or <code>other</code>, then<ol>
<li>If <code>key</code> and <code>keyword</code> consist of the same sequence of Unicode code points, then<ol>
<li>Append <code>key</code> as the last element of the list <code>resultKeyword</code>.</li>
</ol>
</li>
</ol>
</li>
<li>Else, emit a <em>Selection Error</em>.</li>
</ol>
</li>
<li>Return a new list whose elements are the concatenation of the elements (in order) of <code>resultExact</code> followed by the elements (in order) of <code>resultKeyword</code>.</li>
</ol><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Implementations are not required to implement this exactly as written.
However, the observed behavior must be consistent with what is described here.</p>
</div><h6>Rule Selection</h6><p>If the option <code>select</code> is set to <code>exact</code>, rule-based selection is not used.
Return the empty string.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Since valid keys cannot be the empty string in a numeric expression, returning the
empty string disables keyword selection.</p>
</div><p>If the option <code>select</code> is set to <code>plural</code>, selection should be based on CLDR plural rule data
of type <code>cardinal</code>. See <a href="https://www.unicode.org/cldr/charts/latest/supplemental/language_plural_rules.html">charts</a>
for examples.</p><p>If the option <code>select</code> is set to <code>ordinal</code>, selection should be based on CLDR plural rule data
of type <code>ordinal</code>. See <a href="https://www.unicode.org/cldr/charts/latest/supplemental/language_plural_rules.html">charts</a>
for examples.</p><p>Apply the rules defined by CLDR to the resolved value of the operand and the function options,
and return the resulting keyword.
If no rules match, return <code>other</code>.</p><blockquote>
<p><strong>Example.</strong>
In CLDR 44, the Czech (<code>cs</code>) plural rule set can be found
<a href="https://www.unicode.org/cldr/charts/44/supplemental/language_plural_rules.html#cs">here</a>.</p>
<p>A message in Czech might be:</p>
<pre><code>.match {$numDays :number}
one  {{{$numDays} den}}
few  {{{$numDays} dny}}
many {{{$numDays} dne}}
*    {{{$numDays} dní}}
</code></pre>
<p>Using the rules found above, the results of various <em>operand</em> values might look like:</p>
<table>
<thead>
<tr>
<th>Operand value</th>
<th>Keyword</th>
<th>Formatted Message</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td><code>one</code></td>
<td>1 den</td>
</tr>
<tr>
<td>2</td>
<td><code>few</code></td>
<td>2 dny</td>
</tr>
<tr>
<td>5</td>
<td><code>other</code></td>
<td>5 dní</td>
</tr>
<tr>
<td>22</td>
<td><code>few</code></td>
<td>22 dny</td>
</tr>
<tr>
<td>27</td>
<td><code>other</code></td>
<td>27 dní</td>
</tr>
<tr>
<td>2.4</td>
<td><code>many</code></td>
<td>2,4 dne</td>
</tr>
</tbody></table>
</blockquote><h6>Determining Exact Literal Match</h6><div class="markdown-alert markdown-alert-important">
<p class="markdown-alert-title"><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>The exact behavior of exact literal match is only defined for non-zero-filled
integer values.
Annotations that use fraction digits or significant digits might work in specific
implementation-defined ways.
Users should avoid depending on these types of keys in message selection.</p>
</div><p>Number literals in the MessageFormat 2 syntax use the
<a href="https://www.rfc-editor.org/rfc/rfc8259#section-6">format defined for a JSON number</a>.
A <code>resolvedSelector</code> exactly matches a numeric literal <code>key</code>
if, when the numeric value of <code>resolvedSelector</code> is serialized using the format for a JSON number,
the two strings are equal.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Only integer matching is required in the Technical Preview.
Feedback describing use cases for fractional and significant digits-based
selection would be helpful.
Otherwise, users should avoid using matching with fractional numbers or significant digits.</p>
</div><h4>Date and Time Value Formatting</h4><p>This subsection describes the functions and options for date/time formatting.
Selection based on date and time values is not required in this release.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Selection based on date/time types is not required by MF2.
Implementations should use care when defining selectors based on date/time types.
The types of queries found in implementations such as <code>java.time.TemporalAccessor</code>
are complex and user expectations may be inconsistent with good I18N practices.</p>
</div><h5>The <code>:datetime</code> function</h5><p>The function <code>:datetime</code> is used to format date/time values, including
the ability to compose user-specified combinations of fields.</p><p>If no options are specified, this function defaults to the following:</p><ul>
<li><code>{$d :datetime}</code> is the same as <code>{$d :datetime dateStyle=short timeStyle=short}</code></li>
</ul><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The default formatting behavior of <code>:datetime</code> is inconsistent with <code>Intl.DateTimeFormat</code>
in JavaScript and with <code>{d,date}</code> in ICU MessageFormat 1.0.
This is because, unlike those implementations, <code>:datetime</code> is distinct from <code>:date</code> and <code>:time</code>.</p>
</div><h6>Operands</h6><p>The <em>operand</em> of the <code>:datetime</code> function is either
an implementation-defined date/time type
or a <em>date/time literal value</em>, as defined in <a href="#date-and-time-operands">Date and Time Operand</a>.
All other <em>operand</em> values produce an <em>Invalid Expression</em> error.</p><h6>Options</h6><p>The <code>:datetime</code> function can use either the appropriate <em>style options</em>
or can use a collection of <em>field options</em> (but not both) to control the formatted
output.</p><p>If both are specified, an <em>Invalid Expression</em> error MUST be emitted
and a <em>fallback value</em> used as the resolved value of the <em>expression</em>.</p><p><strong>Style Options</strong></p><p>The function <code>:datetime</code> has these <em>style options</em>.</p><ul>
<li><code>dateStyle</code><ul>
<li><code>full</code></li>
<li><code>long</code></li>
<li><code>medium</code></li>
<li><code>short</code></li>
</ul>
</li>
<li><code>timeStyle</code><ul>
<li><code>full</code></li>
<li><code>long</code></li>
<li><code>medium</code></li>
<li><code>short</code></li>
</ul>
</li>
</ul><p><strong>Field Options</strong></p><p><em>Field options</em> describe which fields to include in the formatted output
and what format to use for that field.
The implementation may use this <em>annotation</em> to configure which fields
appear in the formatted output.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p><em>Field options</em> do not have default values because they are only to be used
to compose the formatter.</p>
</div><p>The <em>field options</em> are defined as follows:</p><div class="markdown-alert markdown-alert-important">
<p class="markdown-alert-title"><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>The value <code>2-digit</code> for some <em>field options</em> <strong>must</strong> be quoted
in the MessageFormat syntax because it starts with a digit
but does not match the <code>number-literal</code> production in the ABNF.</p>
<pre><code>.local $correct = {$someDate :datetime year=|2-digit|}
.local $syntaxError = {$someDate :datetime year=2-digit}
</code></pre>
</div><p>The function <code>:datetime</code> has the following options:</p><ul>
<li><code>weekday</code><ul>
<li><code>long</code></li>
<li><code>short</code></li>
<li><code>narrow</code></li>
</ul>
</li>
<li><code>era</code><ul>
<li><code>long</code></li>
<li><code>short</code></li>
<li><code>narrow</code></li>
</ul>
</li>
<li><code>year</code><ul>
<li><code>numeric</code></li>
<li><code>2-digit</code></li>
</ul>
</li>
<li><code>month</code><ul>
<li><code>numeric</code></li>
<li><code>2-digit</code></li>
<li><code>long</code></li>
<li><code>short</code></li>
<li><code>narrow</code></li>
</ul>
</li>
<li><code>day</code><ul>
<li><code>numeric</code></li>
<li><code>2-digit</code></li>
</ul>
</li>
<li><code>hour</code><ul>
<li><code>numeric</code></li>
<li><code>2-digit</code></li>
</ul>
</li>
<li><code>minute</code><ul>
<li><code>numeric</code></li>
<li><code>2-digit</code></li>
</ul>
</li>
<li><code>second</code><ul>
<li><code>numeric</code></li>
<li><code>2-digit</code></li>
</ul>
</li>
<li><code>fractionalSecondDigits</code><ul>
<li><code>1</code></li>
<li><code>2</code></li>
<li><code>3</code></li>
</ul>
</li>
<li><code>hourCycle</code> (default is locale-specific)<ul>
<li><code>h11</code></li>
<li><code>h12</code></li>
<li><code>h23</code></li>
<li><code>h24</code></li>
</ul>
</li>
<li><code>timeZoneName</code><ul>
<li><code>long</code></li>
<li><code>short</code></li>
<li><code>shortOffset</code></li>
<li><code>longOffset</code></li>
<li><code>shortGeneric</code></li>
<li><code>longGeneric</code></li>
</ul>
</li>
</ul><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The following options do not have default values because they are only to be used
as overrides for locale-and-value dependent implementation-defined defaults.</p>
</div><p>The following date/time options are <strong>not</strong> part of the default registry.
Implementations SHOULD avoid creating options that conflict with these, but
are encouraged to track development of these options during Tech Preview:</p><ul>
<li><code>calendar</code> (default is locale-specific)<ul>
<li>valid <a href="https://cldr-smoke.unicode.org/spec/main/ldml/tr35.html#UnicodeCalendarIdentifier">Unicode Calendar Identifier</a></li>
</ul>
</li>
<li><code>numberingSystem</code> (default is locale-specific)<ul>
<li>valid <a href="https://cldr-smoke.unicode.org/spec/main/ldml/tr35.html#UnicodeNumberSystemIdentifier">Unicode Number System Identifier</a></li>
</ul>
</li>
<li><code>timeZone</code> (default is system default time zone or UTC)<ul>
<li>valid identifier per <a href="https://www.rfc-editor.org/rfc/rfc6557">BCP175</a></li>
</ul>
</li>
</ul><h5>The <code>:date</code> function</h5><p>The function <code>:date</code> is used to format the date portion of date/time values.</p><p>If no options are specified, this function defaults to the following:</p><ul>
<li><code>{$d :date}</code> is the same as <code>{$d :date style=short}</code></li>
</ul><h6>Operands</h6><p>The <em>operand</em> of the <code>:date</code> function is either
an implementation-defined date/time type
or a <em>date/time literal value</em>, as defined in <a href="#date-and-time-operands">Date and Time Operand</a>.
All other <em>operand</em> values produce an <em>Invalid Expression</em> error.</p><h6>Options</h6><p>The function <code>:date</code> has these <em>options</em>:</p><ul>
<li><code>style</code><ul>
<li><code>full</code></li>
<li><code>long</code></li>
<li><code>medium</code></li>
<li><code>short</code> (default)</li>
</ul>
</li>
</ul><h5>The <code>:time</code> function</h5><p>The function <code>:time</code> is used to format the time portion of date/time values.</p><p>If no options are specified, this function defaults to the following:</p><ul>
<li><code>{$t :time}</code> is the same as <code>{$t :time style=short}</code></li>
</ul><h6>Operands</h6><p>The <em>operand</em> of the <code>:time</code> function is either
an implementation-defined date/time type
or a <em>date/time literal value</em>, as defined in <a href="#date-and-time-operands">Date and Time Operand</a>.
All other <em>operand</em> values produce an <em>Invalid Expression</em> error.</p><h6>Options</h6><p>The function <code>:time</code> has these <em>options</em>:</p><ul>
<li><code>style</code><ul>
<li><code>full</code></li>
<li><code>long</code></li>
<li><code>medium</code></li>
<li><code>short</code> (default)</li>
</ul>
</li>
</ul><h5>Date and Time Operands</h5><p>The <em>operand</em> of a date/time function is either
an implementation-defined date/time type
or a <em>date/time literal value</em>, as defined below.
All other <em>operand</em> values produce an <em>Invalid Expression</em> error.</p><p>A <strong><em><dfn>date/time literal value</dfn></em></strong> is a non-empty string consisting of an ISO 8601 date,
or an ISO 8601 datetime optionally followed by a timezone offset.
As implementations differ slightly in their parsing of such strings,
ISO 8601 date and datetime values not matching the following regular expression MAY also be supported.
Furthermore, matching this regular expression does not guarantee validity,
given the variable number of days in each month.</p><pre><code class="language-regexp">(?!0000)[0-9]{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])(T([01][0-9]|2[0-3]):[0-5][0-9]:[0-5][0-9](\.[0-9]{1,3})?(Z|[+-]((0[0-9]|1[0-3]):[0-5][0-9]|14:00))?)?
</code></pre><p>When the time is not present, implementations SHOULD use <code>00:00:00</code> as the time.
When the offset is not present, implementations SHOULD use a floating time type
(such as Java's <code>java.time.LocalDateTime</code>) to represent the time value.
For more information, see <a href="https://w3c.github.io/timezone">Working with Timezones</a>.</p><div class="markdown-alert markdown-alert-important">
<p class="markdown-alert-title"><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>The <a href="#complete-abnf">ABNF</a> and <a href="#syntax">syntax</a> of MF2
do not formally define date/time literals.
This means that a <em>message</em> can be syntactically valid but produce
an <em>Operand Mismatch Error</em> at runtime.</p>
</div><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>String values passed as variables in the <em>formatting context</em>'s
<em>input mapping</em> can be formatted as date/time values as long as their
contents are date/time literals.</p>
<p>For example, if the value of the variable <code>now</code> were the string
<code>2024-02-06T16:40:00Z</code>, it would behave identically to the local
variable in this example:</p>
<pre><code>.local $example = {|2024-02-06T16:40:00Z| :datetime}
{{{$now :datetime} == {$example}}}
</code></pre>
</div><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>True time zone support in serializations is expected to coincide with the adoption
of Temporal in JavaScript.
The form of these serializations is known and is a de facto standard.
Support for these extensions is expected to be required in the post-tech preview.
See: <a href="https://datatracker.ietf.org/doc/draft-ietf-sedate-datetime-extended/">https://datatracker.ietf.org/doc/draft-ietf-sedate-datetime-extended/</a></p>
</div><h2>Formatting</h2><p>This section defines the behavior of a MessageFormat 2.0 implementation
when formatting a message for display in a user interface, or for some later processing.</p><p>To start, we presume that a <em>message</em> has either been parsed from its syntax
or created from a data model description.
If this construction has encountered any <em>Syntax Errors</em> or <em>Data Model Errors</em>,
an appropriate error MUST be emitted and a <em>fallback value</em> MAY be used as the formatting result.</p><p>Formatting of a <em>message</em> is defined by the following operations:</p><ul>
<li><p><strong><em>Expression and Markup Resolution</em></strong> determines the value of an <em>expression</em> or <em>markup</em>,
with reference to the current <em>formatting context</em>.
This can include multiple steps,
such as looking up the value of a variable and calling formatting functions.
The form of the resolved value is implementation defined and the
value might not be evaluated or formatted yet.
However, it needs to be "formattable", i.e. it contains everything required
by the eventual formatting.</p>
<p>The resolution of <em>text</em> is rather straightforward,
and is detailed under <em>literal resolution</em>.</p>
</li>
</ul><div class="markdown-alert markdown-alert-important">
<p class="markdown-alert-title"><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p><strong>This specification does not require either eager or lazy <em>expression resolution</em> of <em>message</em>
parts; do not construe any requirement in this document as requiring either.</strong></p>
<p>Implementations are not required to evaluate all parts of a <em>message</em> when
parsing, processing, or formatting.
In particular, an implementation MAY choose not to evaluate or resolve the
value of a given <em>expression</em> until it is actually used by a
selection or formatting process.
However, when an <em>expression</em> is resolved, it MUST behave as if all preceding
<em>declarations</em> and <em>selectors</em> affecting <em>variables</em> referenced by that <em>expression</em>
have already been evaluated in the order in which the relevant <em>declarations</em>
and <em>selectors</em> appear in the <em>message</em>.</p>
</div><ul>
<li><p><strong><em>Pattern Selection</em></strong> determines which of a message's <em>patterns</em> is formatted.
For a message with no <em>selectors</em>, this is simple as there is only one <em>pattern</em>.
With <em>selectors</em>, this will depend on their resolution.</p>
<p>At the start of <em>pattern selection</em>,
if the <em>message</em> contains any <em>reserved statements</em>,
emit an <em>Unsupported Statement</em> error.</p>
</li>
<li><p><strong><em>Formatting</em></strong> takes the resolved values of the selected <em>pattern</em>,
and produces the formatted result for the <em>message</em>.
Depending on the implementation, this result could be a single concatenated string,
an array of objects, an attributed string, or some other locally appropriate data type.</p>
</li>
</ul><p>Formatter implementations are not required to expose
the <em>expression resolution</em> and <em>pattern selection</em> operations to their users,
or even use them in their internal processing,
as long as the final <em>formatting</em> result is made available to users
and the observable behavior of the formatter matches that described here.</p><h3>Formatting Context</h3><p>A message's <strong><em>formatting context</em></strong> represents the data and procedures that are required
for the message's <em>expression resolution</em>, <em>pattern selection</em> and <em>formatting</em>.</p><p>At a minimum, it includes:</p><ul>
<li><p>Information on the current <strong><em>locale</em></strong>,
potentially including a fallback chain of locales.
This will be passed on to formatting functions.</p>
</li>
<li><p>Information on the base directionality of the <em>message</em> and its <em>text</em> tokens.
This will be used by strategies for bidirectional isolation,
and can be used to set the base direction of the <em>message</em> upon display.</p>
</li>
<li><p>An <strong><em><dfn>input mapping</dfn></em></strong> of string identifiers to values,
defining variable values that are available during <em>variable resolution</em>.
This is often determined by a user-provided argument of a formatting function call.</p>
</li>
<li><p>The <em>function registry</em>,
providing the implementations of the functions referred to by message <em>functions</em>.</p>
</li>
<li><p>Optionally, a fallback string to use for the message
if it contains any <em>Syntax Errors</em> or <em>Data Model Errors</em>.</p>
</li>
</ul><p>Implementations MAY include additional fields in their <em>formatting context</em>.</p><h3>Expression and Markup Resolution</h3><p><em>Expressions</em> are used in <em>declarations</em>, <em>selectors</em>, and <em>patterns</em>.
<em>Markup</em> is only used in <em>patterns</em>.</p><p>In a <em>declaration</em>, the resolved value of the <em>expression</em> is bound to a <em>variable</em>,
which is available for use by later <em>expressions</em>.
Since a <em>variable</em> can be referenced in different ways later,
implementations SHOULD NOT immediately fully format the value for output.</p><p>In an <em>input-declaration</em>, the <em>variable</em> operand of the <em>variable-expression</em>
identifies not only the name of the external input value,
but also the <em>variable</em> to which the resolved value of the <em>variable-expression</em> is bound.</p><p>In <em>selectors</em>, the resolved value of an <em>expression</em> is used for <em>pattern selection</em>.</p><p>In a <em>pattern</em>, the resolved value of an <em>expression</em> or <em>markup</em> is used in its <em>formatting</em>.</p><p>The form that resolved values take is implementation-dependent,
and different implementations MAY choose to perform different levels of resolution.</p><blockquote>
<p>For example, the resolved value of the <em>expression</em> <code>{|0.40| :number style=percent}</code>
could be an object such as</p>
<pre><code>{ value: Number('0.40'),
  formatter: NumberFormat(locale, { style: 'percent' }) }
</code></pre>
<p>Alternatively, it could be an instance of an ICU4J <code>FormattedNumber</code>,
or some other locally appropriate value.</p>
</blockquote><p>Depending on the presence or absence of a <em>variable</em> or <em>literal</em> operand
and a <em>function</em>, <em>private-use annotation</em>, or <em>reserved annotation</em>,
the resolved value of the <em>expression</em> is determined as follows:</p><p>If the <em>expression</em> contains a <em>reserved annotation</em>,
an <em>Unsupported Expression</em> error is emitted and
a <em>fallback value</em> is used as the resolved value of the <em>expression</em>.</p><p>Else, if the <em>expression</em> contains a <em>private-use annotation</em>,
its resolved value is defined according to the implementation's specification.</p><p>Else, if the <em>expression</em> contains an <em>annotation</em>,
its resolved value is defined by <em>function resolution</em>.</p><p>Else, if the <em>expression</em> consists of a <em>variable</em>,
its resolved value is defined by <em>variable resolution</em>.
An implementation MAY perform additional processing
when resolving the value of an <em>expression</em>
that consists only of a <em>variable</em>.</p><blockquote>
<p>For example, it could apply <em>function resolution</em> using a <em>function</em>
and a set of <em>options</em> chosen based on the value or type of the <em>variable</em>.
So, given a <em>message</em> like this:</p>
<pre><code>Today is {$date}
</code></pre>
<p>If the value passed in the <em>variable</em> were a date object,
such as a JavaScript <code>Date</code> or a Java <code>java.util.Date</code> or <code>java.time.Temporal</code>,
the implementation could interpret the <em>placeholder</em> <code>{$date}</code> as if
the pattern included the function <code>:datetime</code> with some set of default options.</p>
</blockquote><p>Else, the <em>expression</em> consists of a <em>literal</em>.
Its resolved value is defined by <em>literal resolution</em>.</p><blockquote>
<p><strong>Note</strong>
This means that a <em>literal</em> value with no <em>annotation</em>
is always treated as a string.
To represent values that are not strings as a <em>literal</em>,
an <em>annotation</em> needs to be provided:</p>
<pre><code>.local $aNumber = {1234 :number}
.local $aDate = {|2023-08-30| :datetime}
.local $aFoo = {|some foo| :foo}
{{You have {42 :number}}}
</code></pre>
</blockquote><h4>Literal Resolution</h4><p>The resolved value of a <em>text</em> or a <em>literal</em> is
the character sequence of the <em>text</em> or <em>literal</em>
after any character escape has been converted to the escaped character.</p><p>When a <em>literal</em> is used as an <em>operand</em>
or on the right-hand side of an <em>option</em>,
the formatting function MUST treat its resolved value the same
whether its value was originally <em>quoted</em> or <em>unquoted</em>.</p><blockquote>
<p>For example,
the <em>option</em> <code>foo=42</code> and the <em>option</em> <code>foo=|42|</code> are treated as identical.</p>
</blockquote><p>The resolution of a <em>text</em> or <em>literal</em> MUST resolve to a string.</p><h4>Variable Resolution</h4><p>To resolve the value of a <em>variable</em>,
its <em>name</em> is used to identify either a local variable or an input variable.
If a <em>declaration</em> exists for the <em>variable</em>, its resolved value is used.
Otherwise, the <em>variable</em> is an implicit reference to an input value,
and its value is looked up from the <em>formatting context</em> <em>input mapping</em>.</p><p>The resolution of a <em>variable</em> MAY fail if no value is identified for its <em>name</em>.
If this happens, an <em>Unresolved Variable</em> error MUST be emitted.
If a <em>variable</em> would resolve to a <em>fallback value</em>,
this MUST also be considered a failure.</p><h4>Function Resolution</h4><p>To resolve an <em>expression</em> with a <em>function</em> <em>annotation</em>,
the following steps are taken:</p><ol>
<li><p>If the <em>expression</em> includes an <em>operand</em>, resolve its value.
If this fails, use a <em>fallback value</em> for the <em>expression</em>.</p>
</li>
<li><p>Resolve the <em>identifier</em> of the <em>function</em> and, based on the starting sigil,
find the appropriate function implementation to call.
If the implementation cannot find the function,
or if the <em>identifier</em> includes a <em>namespace</em> that the implementation does not support,
emit an <em>Unknown Function</em> error
and use a <em>fallback value</em> for the <em>expression</em>.</p>
<p>Implementations are not required to implement <em>namespaces</em> or installable
<em>function registries</em>.</p>
</li>
<li><p>Perform <em>option resolution</em>.</p>
</li>
<li><p>Call the function implementation with the following arguments:</p>
<ul>
<li>The current <em>locale</em>.</li>
<li>The resolved mapping of <em>options</em>.</li>
<li>If the <em>expression</em> includes an <em>operand</em>, its resolved value.</li>
</ul>
<p>The form that resolved <em>operand</em> and <em>option</em> values take is implementation-defined.</p>
<p>A <em>declaration</em> binds the resolved value of an <em>expression</em>
to a <em>variable</em>.
Thus, the result of one <em>function</em> is potentially the <em>operand</em>
of another <em>function</em>,
or the value of one of the <em>options</em> for another function.
For example, in</p>
<pre><code>.input {$n :number minIntegerDigits=3}
.local $n1 = {$n :number maxFractionDigits=3}
</code></pre>
<p>the value bound to <code>$n</code> is the
resolved value used as the <em>operand</em>
of the <code>:number</code> <em>function</em>
when resolving the value of the <em>variable</em> <code>$n1</code>.</p>
<p>Implementations that provide a means for defining custom functions
SHOULD provide a means for function implementations
to return values that contain enough information
(e.g. a representation of
the resolved <em>operand</em> and <em>option</em> values
that the function was called with)
to be used as arguments to subsequent calls
to the function implementations.
For example, an implementation might define an interface that allows custom function implementation.
Such an interface SHOULD define an implementation-specific
argument type <code>T</code> and return type <code>U</code>
for implementations of functions
such that <code>U</code> can be coerced to <code>T</code>.
Implementations of a <em>function</em> SHOULD emit an
<em>Invalid Expression</em> error for <em>operands</em> whose resolved value
or type is not supported.</p>
</li>
</ol><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The behavior of the previous example is
currently implementation-dependent. Supposing that
the external input variable <code>n</code> is bound to the string <code>"1"</code>,
and that the implementation formats to a string,
the formatted result of the following message:</p>
<pre><code>.input {$n :number minIntegerDigits=3}
.local $n1 = {$n :number maxFractionDigits=3}
{{$n1}}
</code></pre>
<p>is currently implementation-dependent.
Depending on whether the options are preserved
between the resolution of the first <code>:number</code> <em>annotation</em>
and the resolution of the second <code>:number</code> <em>annotation</em>,
a conformant implementation
could produce either "001.000" or "1.000"</p>
<p>Each function <strong>specification</strong> MAY have
its own rules to preserve some options in the returned structure
and discard others.
In instances where a function specification does not determine whether an option is preserved or discarded,
each function <strong>implementation</strong> of that specification MAY have
its own rules to preserve some options in the returned structure
and discard others.</p>
</div><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>During the Technical Preview,
feedback on how the registry describes
the flow of <em>resolved values</em> and <em>options</em>
from one <em>function</em> to another,
and on what requirements this specification should impose,
is highly desired.</p>
</div><p>   An implementation MAY pass additional arguments to the function,
   as long as reasonable precautions are taken to keep the function interface
   simple and minimal, and avoid introducing potential security vulnerabilities.</p><p>   An implementation MAY define its own functions.
   An implementation MAY allow custom functions to be defined by users.</p><p>   Function access to the <em>formatting context</em> MUST be minimal and read-only,
   and execution time SHOULD be limited.</p><p>   Implementation-defined <em>functions</em> SHOULD use an implementation-defined <em>namespace</em>.</p><ol start="5">
<li><p>If the call succeeds,
resolve the value of the <em>expression</em> as the result of that function call.</p>
<p>If the call fails or does not return a valid value,
emit a <em>Invalid Expression</em> error.</p>
<p>Implementations MAY provide a mechanism for the <em>function</em> to provide
additional detail about internal failures.
Specifically, if the cause of the failure was that the datatype, value, or format of the
<em>operand</em> did not match that expected by the <em>function</em>,
the <em>function</em> might cause an <em>Operand Mismatch Error</em> to be emitted.</p>
<p>In all failure cases, use the <em>fallback value</em> for the <em>expression</em> as the resolved value.</p>
</li>
</ol><h5>Option Resolution</h5><p>The result of resolving <em>option</em> values is an unordered mapping of string identifiers to values.</p><p>For each <em>option</em>:</p><ul>
<li>Resolve the <em>identifier</em> of the <em>option</em>.</li>
<li>If the <em>option</em>'s right-hand side successfully resolves to a value,
 bind the <em>identifier</em> of the <em>option</em> to the resolved value in the mapping.</li>
<li>Otherwise, bind the <em>identifier</em> of the <em>option</em> to an unresolved value in the mapping.
 Implementations MAY later remove this value before calling the <em>function</em>.
 (Note that an <em>Unresolved Variable</em> error will have been emitted.)</li>
</ul><p>Errors MAY be emitted during <em>option resolution</em>,
but it always resolves to some mapping of string identifiers to values.
This mapping can be empty.</p><h4>Markup Resolution</h4><p>Unlike <em>functions</em>, the resolution of <em>markup</em> is not customizable.</p><p>The resolved value of <em>markup</em> includes the following fields:</p><ul>
<li>The type of the markup: open, standalone, or close</li>
<li>The <em>identifier</em> of the <em>markup</em></li>
<li>The resolved <em>options</em> values after <em>option resolution</em>.</li>
</ul><p>The resolution of <em>markup</em> MUST always succeed.</p><h4>Fallback Resolution</h4><p>A <strong><em>fallback value</em></strong> is the resolved value for an <em>expression</em> that fails to resolve.</p><p>An <em>expression</em> fails to resolve when:</p><ul>
<li>A <em>variable</em> used as an <em>operand</em> (with or without an <em>annotation</em>) fails to resolve.<ul>
<li>Note that this does not include a <em>variable</em> used as an <em>option</em> value.</li>
</ul>
</li>
<li>A <em>function</em> <em>annotation</em> fails to resolve.</li>
<li>A <em>private-use annotation</em> is unsupported by the implementation or if
a <em>private-use annotation</em> fails to resolve.</li>
<li>The <em>expression</em> has a <em>reserved annotation</em>.</li>
</ul><p>The <em>fallback value</em> depends on the contents of the <em>expression</em>:</p><ul>
<li><p><em>expression</em> with <em>literal</em> <em>operand</em> (<em>quoted</em> or <em>unquoted</em>):
U+007C VERTICAL LINE <code>|</code>
followed by the value of the <em>literal</em>
with escaping applied to U+005C REVERSE SOLIDUS <code>\</code> and U+007C VERTICAL LINE <code>|</code>,
and then by U+007C VERTICAL LINE <code>|</code>.</p>
<blockquote>
<p>Examples:
In a context where <code>:func</code> fails to resolve,
<code>{42 :func}</code> resolves to the <em>fallback value</em> <code>|42|</code> and
<code>{|C:\\| :func}</code> resolves to the <em>fallback value</em> <code>|C:\\|</code>.
In any context, <code>{|| @reserved}</code> resolves to the <em>fallback value</em> <code>||</code>.</p>
</blockquote>
</li>
<li><p><em>expression</em> with <em>variable</em> <em>operand</em> referring to a local <em>declaration</em> (with or without an <em>annotation</em>):
the <em>value</em> to which it resolves (which may already be a <em>fallback value</em>)</p>
<blockquote>
<p>Examples:
In a context where <code>:func</code> fails to resolve,
the <em>pattern</em>'s <em>expression</em> in <code>.local $var={|val|} {{{$val :func}}}</code>
resolves to the <em>fallback value</em> <code>|val|</code> and the message formats to <code>{|val|}</code>.
In a context where <code>:now</code> fails to resolve but <code>:datetime</code> does not,
the <em>pattern</em>'s <em>expression</em> in</p>
<pre><code>.local $t = {:now format=iso8601}
.local $pretty_t = {$t :datetime}
{{{$pretty_t}}}
</code></pre>
<p>(transitively) resolves to the <em>fallback value</em> <code>:now</code> and
the message formats to <code>{:now}</code>.</p>
</blockquote>
</li>
<li><p><em>expression</em> with <em>variable</em> <em>operand</em> not referring to a local <em>declaration</em> (with or without an <em>annotation</em>):
U+0024 DOLLAR SIGN <code>$</code> followed by the <em>name</em> of the <em>variable</em></p>
<blockquote>
<p>Examples:
In a context where <code>$var</code> fails to resolve, <code>{$var}</code> and <code>{$var :number}</code> and <code>{$var @reserved}</code>
all resolve to the <em>fallback value</em> <code>$var</code>.
In a context where <code>:func</code> fails to resolve,
the <em>pattern</em>'s <em>expression</em> in <code>.input $arg {{{$arg :func}}}</code>
resolves to the <em>fallback value</em> <code>$arg</code> and
the message formats to <code>{$arg}</code>.</p>
</blockquote>
</li>
<li><p><em>function</em> <em>expression</em> with no <em>operand</em>:
U+003A COLON <code>:</code> followed by the <em>function</em> <em>identifier</em></p>
<blockquote>
<p>Examples:
In a context where <code>:func</code> fails to resolve, <code>{:func}</code> resolves to the <em>fallback value</em> <code>:func</code>.
In a context where <code>:ns:func</code> fails to resolve, <code>{:ns:func}</code> resolves to the <em>fallback value</em> <code>:ns:func</code>.</p>
</blockquote>
</li>
<li><p>unsupported <em>private-use annotation</em> or <em>reserved annotation</em> with no <em>operand</em>:
the <em>annotation</em> starting sigil</p>
<blockquote>
<p>Examples:
In any context, <code>{@reserved}</code> and <code>{@reserved |...|}</code> both resolve to the <em>fallback value</em> <code>@</code>.</p>
</blockquote>
</li>
<li><p>supported <em>private-use annotation</em> with no <em>operand</em>:
the <em>annotation</em> starting sigil, optionally followed by implementation-defined details
conforming with patterns in the other cases (such as quoting literals).
If details are provided, they SHOULD NOT leak potentially private information.</p>
<blockquote>
<p>Examples:
In a context where <code>^</code> expressions are used for comments, <code>{^▽^}</code> might resolve to the <em>fallback value</em> <code>^</code>.
In a context where <code>&amp;</code> expressions are <em>function</em>-like macro invocations, <code>{&amp;foo |...|}</code> might resolve to the <em>fallback value</em> <code>&amp;foo</code>.</p>
</blockquote>
</li>
<li><p>Otherwise: the U+FFFD REPLACEMENT CHARACTER <code>�</code></p>
<p>This is not currently used by any expression, but may apply in future revisions.</p>
</li>
</ul><p><em>Option</em> <em>identifiers</em> and values are not included in the <em>fallback value</em>.</p><p><em>Pattern selection</em> is not supported for <em>fallback values</em>.</p><h3>Pattern Selection</h3><p>When a <em>message</em> contains a <em>matcher</em> with one or more <em>selectors</em>,
the implementation needs to determine which <em>variant</em> will be used
to provide the <em>pattern</em> for the formatting operation.
This is done by ordering and filtering the available <em>variant</em> statements
according to their <em>key</em> values and selecting the first one.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>At least one <em>variant</em> is required to have all of its <em>keys</em> consist of
the fallback value <code>*</code>.
Some <em>selectors</em> might be implemented in a way that the key value <code>*</code>
cannot be selected in a <em>valid</em> <em>message</em>.
In other cases, this key value might be unreachable only in certain locales.
This could result in the need in some locales to create
one or more <em>variants</em> that do not make sense grammatically for that language.</p>
<blockquote>
<p>For example, in the <code>pl</code> (Polish) locale, this <em>message</em> cannot reach
the <code>*</code> <em>variant</em>:</p>
<pre><code>.match {$num :integer}
0    {{ }}
one  {{ }}
few  {{ }}
many {{ }}
*    {{Only used by fractions in Polish.}}
</code></pre>
</blockquote>
<p>In the Tech Preview, feedback from users and implementers is desired about
whether to relax the requirement that such a "fallback <em>variant</em>" appear in
every message, versus the potential for a <em>message</em> to fail at runtime
because no matching <em>variant</em> is available.</p>
</div><p>The number of <em>keys</em> in each <em>variant</em> MUST equal the number of <em>selectors</em>.</p><p>Each <em>key</em> corresponds to a <em>selector</em> by its position in the <em>variant</em>.</p><blockquote>
<p>For example, in this message:</p>
<pre><code>.match {:one} {:two} {:three}
1 2 3 {{ ... }}
</code></pre>
<p>The first <em>key</em> <code>1</code> corresponds to the first <em>selector</em> (<code>{:one}</code>),
the second <em>key</em> <code>2</code> to the second <em>selector</em> (<code>{:two}</code>),
and the third <em>key</em> <code>3</code> to the third <em>selector</em> (<code>{:three}</code>).</p>
</blockquote><p>To determine which <em>variant</em> best matches a given set of inputs,
each <em>selector</em> is used in turn to order and filter the list of <em>variants</em>.</p><p>Each <em>variant</em> with a <em>key</em> that does not match its corresponding <em>selector</em>
is omitted from the list of <em>variants</em>.
The remaining <em>variants</em> are sorted according to the <em>selector</em>'s <em>key</em>-ordering preference.
Earlier <em>selectors</em> in the <em>matcher</em>'s list of <em>selectors</em> have a higher priority than later ones.</p><p>When all of the <em>selectors</em> have been processed,
the earliest-sorted <em>variant</em> in the remaining list of <em>variants</em> is selected.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>A <em>selector</em> is not a <em>declaration</em>.
Even when the same <em>function</em> can be used for both formatting and selection
of a given <em>operand</em>
the <em>annotation</em> that appears in a <em>selector</em> has no effect on subsequent
<em>selectors</em> nor on the formatting used in <em>placeholders</em>.
To use the same value for selection and formatting,
set its value with a <code>.input</code> or <code>.local</code> <em>declaration</em>.</p>
</div><p>This selection method is defined in more detail below.
An implementation MAY use any pattern selection method,
as long as its observable behavior matches the results of the method defined here.</p><p>If the message being formatted has any <em>Syntax Errors</em> or <em>Data Model Errors</em>,
the result of pattern selection MUST be a pattern resolving to a single <em>fallback value</em>
using the message's fallback string defined in the <em>formatting context</em>
or if this is not available or empty, the U+FFFD REPLACEMENT CHARACTER <code>�</code>.</p><h4>Resolve Selectors</h4><p>First, resolve the values of each <em>selector</em>:</p><ol>
<li>Let <code>res</code> be a new empty list of resolved values that support selection.</li>
<li>For each <em>selector</em> <code>sel</code>, in source order,<ol>
<li>Let <code>rv</code> be the resolved value of <code>sel</code>.</li>
<li>If selection is supported for <code>rv</code>:<ol>
<li>Append <code>rv</code> as the last element of the list <code>res</code>.</li>
</ol>
</li>
<li>Else:<ol>
<li>Let <code>nomatch</code> be a resolved value for which selection always fails.</li>
<li>Append <code>nomatch</code> as the last element of the list <code>res</code>.</li>
<li>Emit a <em>Selection Error</em>.</li>
</ol>
</li>
</ol>
</li>
</ol><p>The form of the resolved values is determined by each implementation,
along with the manner of determining their support for selection.</p><h4>Resolve Preferences</h4><p>Next, using <code>res</code>, resolve the preferential order for all message keys:</p><ol>
<li>Let <code>pref</code> be a new empty list of lists of strings.</li>
<li>For each index <code>i</code> in <code>res</code>:<ol>
<li>Let <code>keys</code> be a new empty list of strings.</li>
<li>For each <em>variant</em> <code>var</code> of the message:<ol>
<li>Let <code>key</code> be the <code>var</code> key at position <code>i</code>.</li>
<li>If <code>key</code> is not the catch-all key <code>'*'</code>:<ol>
<li>Assert that <code>key</code> is a <em>literal</em>.</li>
<li>Let <code>ks</code> be the resolved value of <code>key</code>.</li>
<li>Append <code>ks</code> as the last element of the list <code>keys</code>.</li>
</ol>
</li>
</ol>
</li>
<li>Let <code>rv</code> be the resolved value at index <code>i</code> of <code>res</code>.</li>
<li>Let <code>matches</code> be the result of calling the method MatchSelectorKeys(<code>rv</code>, <code>keys</code>)</li>
<li>Append <code>matches</code> as the last element of the list <code>pref</code>.</li>
</ol>
</li>
</ol><p>The method MatchSelectorKeys is determined by the implementation.
It takes as arguments a resolved <em>selector</em> value <code>rv</code> and a list of string keys <code>keys</code>,
and returns a list of string keys in preferential order.
The returned list MUST contain only unique elements of the input list <code>keys</code>.
The returned list MAY be empty.
The most-preferred key is first,
with each successive key appearing in order by decreasing preference.</p><h4>Filter Variants</h4><p>Then, using the preferential key orders <code>pref</code>,
filter the list of <em>variants</em> to the ones that match with some preference:</p><ol>
<li>Let <code>vars</code> be a new empty list of <em>variants</em>.</li>
<li>For each <em>variant</em> <code>var</code> of the message:<ol>
<li>For each index <code>i</code> in <code>pref</code>:<ol>
<li>Let <code>key</code> be the <code>var</code> key at position <code>i</code>.</li>
<li>If <code>key</code> is the catch-all key <code>'*'</code>:<ol>
<li>Continue the inner loop on <code>pref</code>.</li>
</ol>
</li>
<li>Assert that <code>key</code> is a <em>literal</em>.</li>
<li>Let <code>ks</code> be the resolved value of <code>key</code>.</li>
<li>Let <code>matches</code> be the list of strings at index <code>i</code> of <code>pref</code>.</li>
<li>If <code>matches</code> includes <code>ks</code>:<ol>
<li>Continue the inner loop on <code>pref</code>.</li>
</ol>
</li>
<li>Else:<ol>
<li>Continue the outer loop on message <em>variants</em>.</li>
</ol>
</li>
</ol>
</li>
<li>Append <code>var</code> as the last element of the list <code>vars</code>.</li>
</ol>
</li>
</ol><h4>Sort Variants</h4><p>Finally, sort the list of variants <code>vars</code> and select the <em>pattern</em>:</p><ol>
<li>Let <code>sortable</code> be a new empty list of (integer, <em>variant</em>) tuples.</li>
<li>For each <em>variant</em> <code>var</code> of <code>vars</code>:<ol>
<li>Let <code>tuple</code> be a new tuple (-1, <code>var</code>).</li>
<li>Append <code>tuple</code> as the last element of the list <code>sortable</code>.</li>
</ol>
</li>
<li>Let <code>len</code> be the integer count of items in <code>pref</code>.</li>
<li>Let <code>i</code> be <code>len</code> - 1.</li>
<li>While <code>i</code> &gt;= 0:<ol>
<li>Let <code>matches</code> be the list of strings at index <code>i</code> of <code>pref</code>.</li>
<li>Let <code>minpref</code> be the integer count of items in <code>matches</code>.</li>
<li>For each tuple <code>tuple</code> of <code>sortable</code>:<ol>
<li>Let <code>matchpref</code> be an integer with the value <code>minpref</code>.</li>
<li>Let <code>key</code> be the <code>tuple</code> <em>variant</em> key at position <code>i</code>.</li>
<li>If <code>key</code> is not the catch-all key <code>'*'</code>:<ol>
<li>Assert that <code>key</code> is a <em>literal</em>.</li>
<li>Let <code>ks</code> be the resolved value of <code>key</code>.</li>
<li>Let <code>matchpref</code> be the integer position of <code>ks</code> in <code>matches</code>.</li>
</ol>
</li>
<li>Set the <code>tuple</code> integer value as <code>matchpref</code>.</li>
</ol>
</li>
<li>Set <code>sortable</code> to be the result of calling the method <code>SortVariants(sortable)</code>.</li>
<li>Set <code>i</code> to be <code>i</code> - 1.</li>
</ol>
</li>
<li>Let <code>var</code> be the <em>variant</em> element of the first element of <code>sortable</code>.</li>
<li>Select the <em>pattern</em> of <code>var</code>.</li>
</ol><p><code>SortVariants</code> is a method whose single argument is
a list of (integer, <em>variant</em>) tuples.
It returns a list of (integer, <em>variant</em>) tuples.
Any implementation of <code>SortVariants</code> is acceptable
as long as it satisfies the following requirements:</p><ol>
<li>Let <code>sortable</code> be an arbitrary list of (integer, <em>variant</em>) tuples.</li>
<li>Let <code>sorted</code> be <code>SortVariants(sortable)</code>.</li>
<li><code>sorted</code> is the result of sorting <code>sortable</code> using the following comparator:<ol>
<li><code>(i1, v1)</code> &lt;= <code>(i2, v2)</code> if and only if <code>i1 &lt;= i2</code>.</li>
</ol>
</li>
<li>The sort is stable (pairs of tuples from <code>sortable</code> that are equal
in their first element have the same relative order in <code>sorted</code>).</li>
</ol><h4>Examples</h4><p><em>This section is non-normative.</em></p><h5>Example 1</h5><p>Presuming a minimal implementation which only supports <code>:string</code> annotation
which matches keys by using string comparison,
and a formatting context in which
the variable reference <code>$foo</code> resolves to the string <code>'foo'</code> and
the variable reference <code>$bar</code> resolves to the string <code>'bar'</code>,
pattern selection proceeds as follows for this message:</p><pre><code>.match {$foo :string} {$bar :string}
bar bar {{All bar}}
foo foo {{All foo}}
* * {{Otherwise}}
</code></pre><ol>
<li><p>For the first selector:<br>
The value of the selector is resolved to be <code>'foo'</code>.<br>
The available keys « <code>'bar'</code>, <code>'foo'</code> » are compared to <code>'foo'</code>,<br>
resulting in a list « <code>'foo'</code> » of matching keys.</p>
</li>
<li><p>For the second selector:<br>
The value of the selector is resolved to be <code>'bar'</code>.<br>
The available keys « <code>'bar'</code>, <code>'foo'</code> » are compared to <code>'bar'</code>,<br>
resulting in a list « <code>'bar'</code> » of matching keys.</p>
</li>
<li><p>Creating the list <code>vars</code> of variants matching all keys:<br>
The first variant <code>bar bar</code> is discarded as its first key does not match the first selector.<br>
The second variant <code>foo foo</code> is discarded as its second key does not match the second selector.<br>
The catch-all keys of the third variant <code>* *</code> always match, and this is added to <code>vars</code>,<br>
resulting in a list « <code>* *</code> » of variants.</p>
</li>
<li><p>As the list <code>vars</code> only has one entry, it does not need to be sorted.<br>
The pattern <code>Otherwise</code> of the third variant is selected.</p>
</li>
</ol><h5>Example 2</h5><p>Alternatively, with the same implementation and formatting context as in Example 1,
pattern selection would proceed as follows for this message:</p><pre><code>.match {$foo :string} {$bar :string}
* bar {{Any and bar}}
foo * {{Foo and any}}
foo bar {{Foo and bar}}
* * {{Otherwise}}
</code></pre><ol>
<li><p>For the first selector:<br>
The value of the selector is resolved to be <code>'foo'</code>.<br>
The available keys « <code>'foo'</code> » are compared to <code>'foo'</code>,<br>
resulting in a list « <code>'foo'</code> » of matching keys.</p>
</li>
<li><p>For the second selector:<br>
The value of the selector is resolved to be <code>'bar'</code>.<br>
The available keys « <code>'bar'</code> » are compared to <code>'bar'</code>,<br>
resulting in a list « <code>'bar'</code> » of matching keys.</p>
</li>
<li><p>Creating the list <code>vars</code> of variants matching all keys:<br>
The keys of all variants either match each selector exactly, or via the catch-all key,<br>
resulting in a list « <code>* bar</code>, <code>foo *</code>, <code>foo bar</code>, <code>* *</code> » of variants.</p>
</li>
<li><p>Sorting the variants:<br>
The list <code>sortable</code> is first set with the variants in their source order
and scores determined by the second selector:<br>
« ( 0, <code>* bar</code> ), ( 1, <code>foo *</code> ), ( 0, <code>foo bar</code> ), ( 1, <code>* *</code> ) »<br>
This is then sorted as:<br>
« ( 0, <code>* bar</code> ), ( 0, <code>foo bar</code> ), ( 1, <code>foo *</code> ), ( 1, <code>* *</code> ) ».<br>
To sort according to the first selector, the scores are updated to:<br>
« ( 1, <code>* bar</code> ), ( 0, <code>foo bar</code> ), ( 0, <code>foo *</code> ), ( 1, <code>* *</code> ) ».<br>
This is then sorted as:<br>
« ( 0, <code>foo bar</code> ), ( 0, <code>foo *</code> ), ( 1, <code>* bar</code> ), ( 1, <code>* *</code> ) ».<br></p>
</li>
<li><p>The pattern <code>Foo and bar</code> of the most preferred <code>foo bar</code> variant is selected.</p>
</li>
</ol><h5>Example 3</h5><p>A more-complex example is the matching found in selection APIs
such as ICU's <code>PluralFormat</code>.
Suppose that this API is represented here by the function <code>:number</code>.
This <code>:number</code> function can match a given numeric value to a specific number <em>literal</em>
and <strong><em>also</em></strong> to a plural category (<code>zero</code>, <code>one</code>, <code>two</code>, <code>few</code>, <code>many</code>, <code>other</code>)
according to locale rules defined in CLDR.</p><p>Given a variable reference <code>$count</code> whose value resolves to the number <code>1</code>
and an <code>en</code> (English) locale,
the pattern selection proceeds as follows for this message:</p><pre><code>.input {$count :number}
.match {$count}
one {{Category match for {$count}}}
1   {{Exact match for {$count}}}
*   {{Other match for {$count}}}
</code></pre><ol>
<li><p>For the selector:<br>
The value of the selector is resolved to an implementation-defined value
that is capable of performing English plural category selection on the value <code>1</code>.<br>
The available keys « <code>'one'</code>, <code>'1'</code> » are passed to
the implementation's MatchSelectorKeys method,<br>
resulting in a list « <code>'1'</code>, <code>'one'</code> » of matching keys.</p>
</li>
<li><p>Creating the list <code>vars</code> of variants matching all keys:<br>
The keys of all variants are included in the list of matching keys, or use the catch-all key,<br>
resulting in a list « <code>one</code>, <code>1</code>, <code>*</code> » of variants.</p>
</li>
<li><p>Sorting the variants:<br>
The list <code>sortable</code> is first set with the variants in their source order
and scores determined by the selector key order:<br>
« ( 1, <code>one</code> ), ( 0, <code>1</code> ), ( 2, <code>*</code> ) »<br>
This is then sorted as:<br>
« ( 0, <code>1</code> ), ( 1, <code>one</code> ), ( 2, <code>*</code> ) »<br></p>
</li>
<li><p>The pattern <code>Exact match for {$count}</code> of the most preferred <code>1</code> variant is selected.</p>
</li>
</ol><h3>Formatting</h3><p>After <em>pattern selection</em>,
each <em>text</em> and <em>placeholder</em> part of the selected <em>pattern</em> is resolved and formatted.</p><p>Resolved values cannot always be formatted by a given implementation.
When such an error occurs during <em>formatting</em>,
an implementation SHOULD emit a <em>Formatting Error</em> and produce a
<em>fallback value</em> for the <em>placeholder</em> that produced the error.
A formatting function MAY substitute a value to use instead of a <em>fallback value</em>.</p><p>Implementations MAY represent the result of <em>formatting</em> using the most
appropriate data type or structure. Some examples of these include:</p><ul>
<li>A single string concatenated from the parts of the resolved <em>pattern</em>.</li>
<li>A string with associated attributes for portions of its text.</li>
<li>A flat sequence of objects corresponding to each resolved value.</li>
<li>A hierarchical structure of objects that group spans of resolved values,
such as sequences delimited by <em>markup-open</em> and <em>markup-close</em> <em>placeholders</em>.</li>
</ul><p>Implementations SHOULD provide <em>formatting</em> result types that match user needs,
including situations that require further processing of formatted messages.
Implementations SHOULD encourage users to consider a formatted localised string
as an opaque data structure, suitable only for presentation.</p><p>When formatting to a string, the default representation of all <em>markup</em>
MUST be an empty string.
Implementations MAY offer functionality for customizing this,
such as by emitting XML-ish tags for each <em>markup</em>.</p><p><em>Attributes</em> are reserved for future standardization.
Other than checking for valid syntax, they SHOULD NOT
affect the processing or output of a <em>message</em>.</p><h4>Examples</h4><p><em>This section is non-normative.</em></p><ol>
<li><p>An implementation might choose to return an interstitial object
so that the caller can "decorate" portions of the formatted value.
In ICU4J, the <code>NumberFormatter</code> class returns a <code>FormattedNumber</code> object,
so a <em>pattern</em> such as <code>This is my number {42 :number}</code> might return
the character sequence <code>This is my number </code>
followed by a <code>FormattedNumber</code> object representing the value <code>42</code> in the current locale.</p>
</li>
<li><p>A formatter in a web browser could format a message as a DOM fragment
rather than as a representation of its HTML source.</p>
</li>
</ol><h4>Formatting Fallback Values</h4><p>If the resolved <em>pattern</em> includes any <em>fallback values</em>
and the formatting result is a concatenated string or a sequence of strings,
the string representation of each <em>fallback value</em> MUST be the concatenation of
a U+007B LEFT CURLY BRACKET <code>{</code>,
the <em>fallback value</em> as a string,
and a U+007D RIGHT CURLY BRACKET <code>}</code>.</p><blockquote>
<p>For example,
a message with a <em>Syntax Error</em> and no fallback string
defined in the <em>formatting context</em> would format to a string as <code>{�}</code>.</p>
</blockquote><h4>Handling Bidirectional Text</h4><p><em>Messages</em> contain text. Any text can be
<a href="https://www.w3.org/TR/i18n-glossary/#dfn-bidirectional-text">bidirectional text</a>.
That is, the text can can consist of a mixture of left-to-right and right-to-left spans of text.
The display of bidirectional text is defined by the
<a href="http://www.unicode.org/reports/tr9/">Unicode Bidirectional Algorithm</a> [UAX9].</p><p>The directionality of the message as a whole is provided by the <em>formatting context</em>.</p><p>When a <em>message</em> is formatted, <em>placeholders</em> are replaced
with their formatted representation.
Applying the Unicode Bidirectional Algorithm to the text of a formatted <em>message</em>
(including its formatted parts)
can result in unexpected or undesirable
<a href="https://www.w3.org/TR/i18n-glossary/#dfn-spillover-effects">spillover effects</a>.
Applying <a href="https://www.w3.org/TR/i18n-glossary/#dfn-bidi-isolation">bidi isolation</a>
to each affected formatted value helps avoid this spillover in a formatted <em>message</em>.</p><p>Note that both the <em>message</em> and, separately, each <em>placeholder</em> need to have
direction metadata for this to work.
If an implementation supports formatting to something other than a string
(such as a sequence of parts),
the directionality of each formatted <em>placeholder</em> needs to be available to the caller.</p><p>If a formatted <em>expression</em> itself contains spans with differing directionality,
its formatter SHOULD perform any necessary processing, such as inserting controls or
isolating such parts to ensure that the formatted value displays correctly in a plain text context.</p><blockquote>
<p>For example, an implementation could provide a <code>:currency</code> formatting function
which inserts strongly directional characters, such as U+200F RIGHT-TO-LEFT MARK (RLM),
U+200E LEFT-TO-RIGHT MARK (LRM), or U+061C ARABIC LETTER MARKER (ALM),
to coerce proper display of the sign and currency symbol next to a formatted number.
An example of this is formatting the value <code>-1234.56</code> as the currency <code>AED</code>
in the <code>ar-AE</code> locale. The formatted value appears like this:</p>
<pre><code>‎-1,234.56&nbsp;د.إ.‏
</code></pre>
<p>The code point sequence for this string, as produced by the ICU4J <code>NumberFormat</code> function,
includes <strong>U+200F U+200E</strong> at the start and <strong>U+200F</strong> at the end of the string.
If it did not do this, the same string would appear like this instead:</p>
<p><img src="images/messageFormatCurrencyExample.png" alt="image"></p>
</blockquote><p>A <strong><em>bidirectional isolation strategy</em></strong> is functionality in the formatter's
processing of a <em>message</em> that produces bidirectional output text that is ready for display.</p><p>The <strong><em>Default Bidi Strategy</em></strong> is a <em>bidirectional isolation strategy</em> that uses
isolating Unicode control characters around <em>placeholder</em>'s formatted values.
It is primarily intended for use in plain-text strings, where markup or other mechanisms
are not available.
Implementations MUST provide the <em>Default Bidi Strategy</em> as one of the
<em>bidirectional isolation strategies</em>.</p><p>Implementations MAY provide other <em>bidirectional isolation strategies</em>.</p><p>Implementations MAY supply a <em>bidirectional isolation strategy</em> that performs no processing.</p><p>The <em>Default Bidi Strategy</em> is defined as follows:</p><ol>
<li>Let <code>msgdir</code> be the directionality of the whole message,
one of « <code>'LTR'</code>, <code>'RTL'</code>, <code>'unknown'</code> ».
These correspond to the message having left-to-right directionality,
right-to-left directionality, and to the message's directionality not being known.</li>
<li>For each <em>expression</em> <code>exp</code> in <em>pattern</em>:<ol>
<li>Let <code>fmt</code> be the formatted string representation of the resolved value of <code>exp</code>.</li>
<li>Let <code>dir</code> be the directionality of <code>fmt</code>,
one of « <code>'LTR'</code>, <code>'RTL'</code>, <code>'unknown'</code> », with the same meanings as for <code>msgdir</code>.</li>
<li>If <code>dir</code> is <code>'LTR'</code>:<ol>
<li>If <code>msgdir</code> is <code>'LTR'</code>
in the formatted output, let <code>fmt</code> be itself</li>
<li>Else, in the formatted output,
prefix <code>fmt</code> with U+2066 LEFT-TO-RIGHT ISOLATE
and postfix it with U+2069 POP&nbsp;DIRECTIONAL&nbsp;ISOLATE.</li>
</ol>
</li>
<li>Else, if <code>dir</code> is <code>'RTL'</code>:<ol>
<li>In the formatted output,
prefix <code>fmt</code> with U+2067 RIGHT-TO-LEFT ISOLATE
and postfix it with U+2069 POP&nbsp;DIRECTIONAL&nbsp;ISOLATE.</li>
</ol>
</li>
<li>Else:<ol>
<li>In the formatted output,
prefix <code>fmt</code> with U+2068 FIRST STRONG ISOLATE
and postfix it with U+2069 POP&nbsp;DIRECTIONAL&nbsp;ISOLATE.</li>
</ol>
</li>
</ol>
</li>
</ol><h2>Interchange Data Model</h2><p>This section defines a data model representation of MessageFormat 2 <em>messages</em>.</p><p>Implementations are not required to use this data model for their internal representation of messages.
Neither are they required to provide an interface that accepts or produces
representations of this data model.</p><p>The major reason this specification provides a data model is to allow interchange of
the logical representation of a <em>message</em> between different implementations.
This includes mapping legacy formatting syntaxes (such as MessageFormat 1)
to a MessageFormat 2 implementation.
Another use would be in converting to or from translation formats without
the need to continually parse and serialize all or part of a message.</p><p>Implementations that expose APIs supporting the production, consumption, or transformation of a
<em>message</em> as a data structure are encouraged to use this data model.</p><p>This data model provides these capabilities:</p><ul>
<li>any MessageFormat 2 message (including future versions)
can be parsed into this representation</li>
<li>this data model representation can be serialized as a well-formed
MessageFormat 2 message</li>
<li>parsing a MessageFormat 2 message into a data model representation
and then serializing it results in an equivalently functional message</li>
</ul><p>This data model might also be used to:</p><ul>
<li>parse a non-MessageFormat 2 message into a data model
(and therefore re-serialize it as MessageFormat 2).
Note that this depends on compatibility between the two syntaxes.</li>
<li>re-serialize a MessageFormat 2 message into some other format
including (but not limited to) other formatting syntaxes
or translation formats.</li>
</ul><p>To ensure compatibility across all platforms,
this interchange data model is defined here using TypeScript notation.
Two equivalent definitions of the data model are also provided:</p><ul>
<li><code>common/dtd/messageFormat/message.json</code> is a JSON Schema definition,
for use with message data encoded as JSON or compatible formats, such as YAML.</li>
<li><code>common/dtd/messageFormat/message.json</code> is a document type definition (DTD),
for use with message data encoded as XML.</li>
</ul><p>Note that while the data model description below is the canonical one,
the JSON and DTD definitions are intended for interchange between systems and processors.
To that end, they relax some aspects of the data model, such as allowing
declarations, options, and attributes to be optional rather than required properties.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Users relying on XML representations of messages should note that
XML 1.0 does not allow for the representation of all C0 control characters (U+0000-U+001F).
Except for U+0000 NULL , these characters are allowed in MessageFormat 2 messages,
so systems and users relying on this XML representation for interchange
might need to supply an alternate escape mechanism to support messages
that contain these characters.</p>
</div><div class="markdown-alert markdown-alert-important">
<p class="markdown-alert-title"><svg class="octicon octicon-report mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>The data model uses the field name <code>name</code> to denote various interface identifiers.
In the MessageFormat 2 <a href="#syntax">syntax</a>, the source for these <code>name</code> fields
sometimes uses the production <code>identifier</code>.
This happens when the named item, such as a <em>function</em>, supports namespacing.</p>
<p>In the Tech Preview, feedback on whether to separate the <code>namespace</code> from the <code>name</code>
and represent both separately, or just, as here, use an opaque single field <code>name</code>
is desired.</p>
</div><h3>Messages</h3><p>A <code>SelectMessage</code> corresponds to a syntax message that includes <em>selectors</em>.
A message without <em>selectors</em> and with a single <em>pattern</em> is represented by a <code>PatternMessage</code>.</p><p>In the syntax,
a <code>PatternMessage</code> may be represented either as a <em>simple message</em> or as a <em>complex message</em>,
depending on whether it has declarations and if its <code>pattern</code> is allowed in a <em>simple message</em>.</p><pre><code class="language-ts">type Message = PatternMessage | SelectMessage;

interface PatternMessage {
  type: "message";
  declarations: Declaration[];
  pattern: Pattern;
}

interface SelectMessage {
  type: "select";
  declarations: Declaration[];
  selectors: Expression[];
  variants: Variant[];
}
</code></pre><p>Each message <em>declaration</em> is represented by a <code>Declaration</code>,
which connects the <code>name</code> of a <em>variable</em>
with its <em>expression</em> <code>value</code>.
The <code>name</code> does not include the initial <code>$</code> of the <em>variable</em>.</p><p>The <code>name</code> of an <code>InputDeclaration</code> MUST be the same
as the <code>name</code> in the <code>VariableRef</code> of its <code>VariableExpression</code> <code>value</code>.</p><p>An <code>UnsupportedStatement</code> represents a statement not supported by the implementation.
Its <code>keyword</code> is a non-empty string name (i.e. not including the initial <code>.</code>).
If not empty, the <code>body</code> is the "raw" value (i.e. escape sequences are not processed)
starting after the keyword and up to the first <em>expression</em>,
not including leading or trailing whitespace.
The non-empty <code>expressions</code> correspond to the trailing <em>expressions</em> of the <em>reserved statement</em>.</p><div class="markdown-alert markdown-alert-note">
<p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Be aware that future versions of this specification
might assign meaning to <em>reserved statement</em> values.
This would result in new interfaces being added to
this data model.</p>
</div><pre><code class="language-ts">type Declaration = InputDeclaration | LocalDeclaration | UnsupportedStatement;

interface InputDeclaration {
  type: "input";
  name: string;
  value: VariableExpression;
}

interface LocalDeclaration {
  type: "local";
  name: string;
  value: Expression;
}

interface UnsupportedStatement {
  type: "unsupported-statement";
  keyword: string;
  body?: string;
  expressions: Expression[];
}
</code></pre><p>In a <code>SelectMessage</code>,
the <code>keys</code> and <code>value</code> of each <em>variant</em> are represented as an array of <code>Variant</code>.
For the <code>CatchallKey</code>, a string <code>value</code> may be provided to retain an identifier.
This is always <code>'*'</code> in MessageFormat 2 syntax, but may vary in other formats.</p><pre><code class="language-ts">interface Variant {
  keys: Array&lt;Literal | CatchallKey&gt;;
  value: Pattern;
}

interface CatchallKey {
  type: "*";
  value?: string;
}
</code></pre><h3>Patterns</h3><p>Each <code>Pattern</code> contains a linear sequence of text and placeholders corresponding to potential output of a message.</p><p>Each element of the <code>Pattern</code> MUST either be a non-empty string, an <code>Expression</code>, or a <code>Markup</code> object.
String values represent literal <em>text</em>.
String values include all processing of the underlying <em>text</em> values,
including escape sequence processing.
<code>Expression</code> wraps each of the potential <em>expression</em> shapes.
<code>Markup</code> wraps each of the potential <em>markup</em> shapes.</p><p>Implementations MUST NOT rely on the set of <code>Expression</code> and
<code>Markup</code> interfaces defined in this document being exhaustive.
Future versions of this specification might define additional
expressions or markup.</p><pre><code class="language-ts">type Pattern = Array&lt;string | Expression | Markup&gt;;

type Expression =
  | LiteralExpression
  | VariableExpression
  | FunctionExpression
  | UnsupportedExpression;

interface LiteralExpression {
  type: "expression";
  arg: Literal;
  annotation?: FunctionAnnotation | UnsupportedAnnotation;
  attributes: Attribute[];
}

interface VariableExpression {
  type: "expression";
  arg: VariableRef;
  annotation?: FunctionAnnotation | UnsupportedAnnotation;
  attributes: Attribute[];
}

interface FunctionExpression {
  type: "expression";
  arg?: never;
  annotation: FunctionAnnotation;
  attributes: Attribute[];
}

interface UnsupportedExpression {
  type: "expression";
  arg?: never;
  annotation: UnsupportedAnnotation;
  attributes: Attribute[];
}

interface Attribute {
  name: string;
  value?: Literal | VariableRef;
}
</code></pre><h3>Expressions</h3><p>The <code>Literal</code> and <code>VariableRef</code> correspond to the the <em>literal</em> and <em>variable</em> syntax rules.
When they are used as the <code>body</code> of an <code>Expression</code>,
they represent <em>expression</em> values with no <em>annotation</em>.</p><p><code>Literal</code> represents all literal values, both <em>quoted</em> and <em>unquoted</em>.
The presence or absence of quotes is not preserved by the data model.
The <code>value</code> of <code>Literal</code> is the "cooked" value (i.e. escape sequences are processed).</p><p>In a <code>VariableRef</code>, the <code>name</code> does not include the initial <code>$</code> of the <em>variable</em>.</p><pre><code class="language-ts">interface Literal {
  type: "literal";
  value: string;
}

interface VariableRef {
  type: "variable";
  name: string;
}
</code></pre><p>A <code>FunctionAnnotation</code> represents a <em>function</em> <em>annotation</em>.
The <code>name</code> does not include the <code>:</code> starting sigil.</p><p>Each <em>option</em> is represented by an <code>Option</code>.</p><pre><code class="language-ts">interface FunctionAnnotation {
  type: "function";
  name: string;
  options: Option[];
}

interface Option {
  name: string;
  value: Literal | VariableRef;
}
</code></pre><p>An <code>UnsupportedAnnotation</code> represents a
<em>private-use annotation</em> not supported by the implementation or a <em>reserved annotation</em>.
The <code>source</code> is the "raw" value (i.e. escape sequences are not processed),
including the starting sigil.</p><p>When parsing the syntax of a <em>message</em> that includes a <em>private-use annotation</em>
supported by the implementation,
the implementation SHOULD represent it in the data model
using an interface appropriate for the semantics and meaning
that the implementation attaches to that <em>annotation</em>.</p><pre><code class="language-ts">interface UnsupportedAnnotation {
  type: "unsupported-annotation";
  source: string;
}
</code></pre><h3>Markup</h3><p>A <code>Markup</code> object has a <code>kind</code> of either <code>"open"</code>, <code>"standalone"</code>, or <code>"close"</code>,
each corresponding to <em>open</em>, <em>standalone</em>, and <em>close</em> <em>markup</em>.
The <code>name</code> in these does not include the starting sigils <code>#</code> and <code>/</code>
or the ending sigil <code>/</code>.
The optional <code>options</code> for markup use the same <code>Option</code> as <code>FunctionAnnotation</code>.</p><pre><code class="language-ts">interface Markup {
  type: "markup";
  kind: "open" | "standalone" | "close";
  name: string;
  options: Option[];
  attributes: Attribute[];
}
</code></pre><h3>Extensions</h3><p>Implementations MAY extend this data model with additional interfaces,
as well as adding new fields to existing interfaces.
When encountering an unfamiliar field, an implementation MUST ignore it.
For example, an implementation could include a <code>span</code> field on all interfaces
encoding the corresponding start and end positions in its source syntax.</p><p>In general,
implementations MUST NOT extend the sets of values for any defined field or type
when representing a valid message.
However, when using this data model to represent an invalid message,
an implementation MAY do so.
This is intended to allow for the representation of "junk" or invalid content within messages.</p><h2>Appendices</h2><h3>Security Considerations</h3><p>MessageFormat 2.0 <em>patterns</em> are meant to allow a <em>message</em> to include any string value
which users might normally wish to use in their environment.
Programming languages and other environments vary in what characters are permitted
to appear in a valid string.
In many cases, certain types of characters, such as invisible control characters,
require escaping by these host formats.
In other cases, strings are not permitted to contain certain characters at all.
Since <em>messages</em> are subject to the restrictions and limitations of their
host environments, their serializations and resource formats,
that might be sufficient to prevent most problems.
However, MessageFormat itself does not supply such a restriction.</p><p>MessageFormat <em>messages</em> permit nearly all Unicode code points,
with the exception of surrogates,
to appear in <em>literals</em>, including the text portions of a <em>pattern</em>.
This means that it can be possible for a <em>message</em> to contain invisible characters
(such as bidirectional controls,
ASCII control characters in the range U+0000 to U+001F,
or characters that might be interpreted as escapes or syntax in the host format)
that abnormally affect the display of the <em>message</em>
when viewed as source code, or in resource formats or translation tools,
but do not generate errors from MessageFormat parsers or processing APIs.</p><p>Bidirectional text containing right-to-left characters (such as used for Arabic or Hebrew)
also poses a potential source of confusion for users.
Since MessageFormat 2.0's syntax makes use of
keywords and symbols that are left-to-right or consist of neutral characters
(including characters subject to mirroring under the Unicode Bidirectional Algorithm),
it is possible to create messages that,
when displayed in source code, or in resource formats or translation tools,
have a misleading appearance or are difficult to parse visually.</p><p>For more information, see [<a href="https://unicode.org/reports/tr55/">UTS#55</a>]
<cite>Unicode Source Code Handling</cite>.</p><p>MessageFormat 2.0 implementations might allow end-users to install
<em>selectors</em>, <em>functions</em>, or <em>markup</em> from third-party sources.
Such functionality can be a vector for various exploits,
including buffer overflow, code injection, user tracking,
fingerprinting, and other types of bad behavior.
Any installed code needs to be appropriately sandboxed.
In addition, end-users need to be aware of the risks involved.</p><h3>Acknowledgements</h3><p>Special thanks to the following people for their contributions to making MessageFormat v2.
The following people contributed to our github repo and are listed in order by contribution size:</p><p>Addison Phillips,
Eemeli Aro,
Romulo Cintra,
Stanisław Małolepszy,
Elango Cheran,
Richard Gibson,
Tim Chevalier,
Mihai Niță,
Shane F. Carr,
Mark Davis,
Steven R. Loomis,
Caleb Maclennan,
David Filip,
Daniel Minor,
Christopher Dieringer,
George Rhoten,
Ujjwal Sharma,
Daniel Ehrenberg,
Markus Scherer,
Zibi Braniecki,
Matt Radbourne,
Bruno Haible,
and Rafael Xavier de Souza.</p><p>Addison Phillips was chair of the working group from January 2023.
Prior to 2023, the group was governed by a chair group, consisting of
Romulo Cintra,
Elango Cheran,
Mihai Niță,
David Filip,
Nicolas Bouvrette,
Stanisław Małolepszy,
Rafael Xavier de Souza,
Addison Phillips,
and Daniel Minor.
Romulo Cintra chaired the chair group.</p><hr><p>Copyright © 2001–2024 Unicode, Inc. All Rights Reserved. The Unicode Consortium makes no expressed or implied warranty of any kind, and assumes no liability for errors or omissions. No liability is assumed for incidental and consequential damages in connection with or arising out of the use of the information or programs contained or accompanying this technical report. The Unicode <a href="https://www.unicode.org/copyright.html">Terms of Use</a> apply.</p><p>Unicode and the Unicode logo are trademarks of Unicode, Inc., and are registered in some jurisdictions.</p></div><script>anchors.add('h1, h2, h3, h4, h5, h6, caption, dfn');</script></body></html>